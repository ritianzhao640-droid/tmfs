<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>è°ƒè¯• - è¸é©¬å°ç¥åˆçº¦</title>
  <style>
    body{background:#0b0f17;color:#fff;font-family:system-ui;padding:20px}
    .log{background:#1e293b;padding:10px;margin:10px 0;border-radius:8px;font-family:monospace;font-size:13px}
    .error{color:#ef4444}
    .success{color:#10b981}
    button{background:#3b82f6;color:#fff;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;margin:5px}
  </style>
</head>
<body>
  <h2>ğŸ” åˆçº¦è°ƒè¯•å·¥å…·</h2>
  <button onclick="checkNetwork()">1. æ£€æŸ¥ç½‘ç»œ</button>
  <button onclick="checkContract()">2. æ£€æŸ¥åˆçº¦</button>
  <button onclick="checkBalance()">3. æŸ¥è¯¢ä½™é¢</button>
  <div id="logs"></div>

<script src="https://cdn.jsdelivr.net/npm/web3@1.10.3/dist/web3.min.js"></script>
<script>
const CONTRACT = "0x9a889E525FAEF4851bf5BEbfb5F294AC9D097777";
const ACCOUNT = "0xd9ed...517f"; // æ¢æˆæ‚¨çš„çœŸå®åœ°å€ï¼Œæˆ–è€…è¿æ¥é’±åŒ…åè‡ªåŠ¨è·å–

function log(msg, type='info') {
  const div = document.createElement('div');
  div.className = 'log ' + type;
  div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${msg}`;
  document.getElementById('logs').prepend(div);
}

async function checkNetwork() {
  if (!window.ethereum) {
    log('âŒ æœªæ£€æµ‹åˆ°é’±åŒ…æ’ä»¶ï¼Œè¯·å®‰è£… MetaMask æˆ– TokenPocket', 'error');
    return;
  }
  
  const web3 = new Web3(window.ethereum);
  const chainId = await web3.eth.getChainId();
  const networks = {56:'BSC Mainnet', 97:'BSC Testnet', 1:'Ethereum', 5:'Goerli'};
  
  log(`å½“å‰ç½‘ç»œ: ${networks[chainId] || 'Unknown'} (ChainID: ${chainId})`);
  
  if (chainId !== 56) {
    log('âš ï¸ è­¦å‘Šï¼šæ‚¨ä¸åœ¨ BSC ä¸»ç½‘ï¼è¯·åˆ‡æ¢åˆ° BSC Mainnet', 'error');
  } else {
    log('âœ… ç½‘ç»œæ­£ç¡®ï¼šBSC Mainnet', 'success');
  }
}

async function checkContract() {
  try {
    const web3 = new Web3(window.ethereum);
    const code = await web3.eth.getCode(CONTRACT);
    
    if (code === '0x' || code === '0x0') {
      log('âŒ åˆçº¦åœ°å€æ— æ•ˆï¼šè¯¥åœ°å€æ²¡æœ‰éƒ¨ç½²åˆçº¦', 'error');
    } else {
      log(`âœ… åˆçº¦å­˜åœ¨ï¼Œä»£ç é•¿åº¦: ${code.length} å­—èŠ‚`, 'success');
      log('åˆçº¦ä»£ç å‰100å­—ç¬¦: ' + code.substring(0, 100) + '...');
    }
  } catch (err) {
    log('âŒ æ£€æŸ¥åˆçº¦å¤±è´¥: ' + err.message, 'error');
  }
}

async function checkBalance() {
  try {
    await window.ethereum.request({ method: 'eth_requestAccounts' });
    const web3 = new Web3(window.ethereum);
    const accounts = await web3.eth.getAccounts();
    const account = accounts[0];
    
    log(`å½“å‰é’±åŒ…åœ°å€: ${account}`);
    
    // å°è¯•å¤šç§ ABI æ ¼å¼
    const abis = [
      // æ ‡å‡† ERC20
      [{"constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"type":"function"}],
      // æœ‰äº›åˆçº¦ç”¨ account è€Œä¸æ˜¯ _owner
      [{"constant":true,"inputs":[{"name":"account","type":"address"}],"name":"balanceOf","outputs":[{"name":"","type":"uint256"}],"type":"function"}],
      // æœ€ç®€å•çš„æ ¼å¼
      [{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}]
    ];
    
    for (let i = 0; i < abis.length; i++) {
      try {
        const contract = new web3.eth.Contract(abis[i], CONTRACT);
        const balance = await contract.methods.balanceOf(account).call();
        const balanceEth = web3.utils.fromWei(balance, 'ether');
        log(`âœ… ABI æ ¼å¼ ${i+1} æˆåŠŸï¼ä½™é¢: ${balanceEth} è¸é©¬å°ç¥`, 'success');
        return;
      } catch (e) {
        log(`âŒ ABI æ ¼å¼ ${i+1} å¤±è´¥: ${e.message}`, 'error');
      }
    }
    
    log('æ‰€æœ‰ ABI æ ¼å¼éƒ½å¤±è´¥ï¼Œè¯·æ£€æŸ¥åˆçº¦æ˜¯å¦åŒ…å« balanceOf å‡½æ•°', 'error');
    
  } catch (err) {
    log('âŒ è¿æ¥é’±åŒ…å¤±è´¥: ' + err.message, 'error');
  }
}
</script>
</body>
</html>
