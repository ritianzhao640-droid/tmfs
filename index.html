<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>è¸é©¬å°ç¥ - ç‡ƒçƒ§åˆ†çº¢</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:#0b0f17;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto}
    .container{max-width:420px;margin:0 auto;padding:25px}
    
    .wallet-bar {
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      border: 1px solid #334155;
      border-radius: 12px;
      padding: 12px 16px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    .wallet-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #ef4444;
      box-shadow: 0 0 8px #ef4444;
      transition: all 0.3s;
    }
    .status-dot.connected {
      background: #10b981;
      box-shadow: 0 0 8px #10b981;
    }
    .wallet-btn {
      background: #3b82f6;
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .wallet-btn:hover {
      background: #2563eb;
    }
    .wallet-btn.disconnect {
      background: #475569;
    }
    .wallet-info {
      font-size: 12px;
      color: #94a3b8;
      margin-top: 4px;
      width: 100%;
      display: flex;
      justify-content: space-between;
    }
    .wallet-select {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .wallet-select.show {
      display: flex;
    }
    .wallet-modal {
      background: #1e293b;
      border-radius: 16px;
      padding: 20px;
      width: 90%;
      max-width: 360px;
    }
    .wallet-modal h3 {
      margin-bottom: 16px;
      text-align: center;
      color: #fff;
    }
    .wallet-option {
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      transition: all 0.2s;
    }
    .wallet-option:hover {
      border-color: #3b82f6;
      background: #1e293b;
    }
    .wallet-option div:first-child {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #fff;
    }
    .wallet-option-info {
      flex: 1;
    }
    .wallet-option-title {
      font-weight: 600;
      font-size: 15px;
    }
    .wallet-option-desc {
      font-size: 12px;
      color: #64748b;
      margin-top: 2px;
    }
    
    .card{background:#121a29;border-radius:16px;padding:24px;margin-bottom:16px}
    .title{font-size:22px;font-weight:700;color:#ffdf4f;margin-bottom:6px}
    .subtitle{color:#9ca3af;font-size:14px;margin-bottom:20px}
    .input-box{position:relative}
    input{width:100%;background:#1e293b;border:none;border-radius:12px;padding:14px 16px;color:#fff;font-size:16px;margin-bottom:12px}
    button{width:100%;padding:16px;border:none;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer}
    .btn-burn{background:#ef4444;color:#fff}
    .btn-burn:hover {background: #dc2626;}
    .btn-claim{background:#10b981;color:#fff;margin-top:8px}
    .btn-claim:hover {background: #059669;}
    .btn-claim:disabled {background: #334155;cursor: not-allowed;}
    .panel{display:flex;justify-content:space-between;background:#111827;padding:14px 16px;border-radius:12px;margin-bottom:10px;align-items:center}
    .label{color:#9ca3af;font-size:13px}
    .value{color:#fff;font-weight:600;font-size:16px}
    .balance-tag {
      font-size: 11px;
      color: #64748b;
      margin-top: 4px;
    }
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #fff;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-left: 8px;
      vertical-align: middle;
    }
    @keyframes spin {to {transform: rotate(360deg);}}
  </style>
</head>
<body>
<div class="container">

  <!-- é’±åŒ…è¿æ¥çŠ¶æ€æ  -->
  <div class="wallet-bar" id="walletBar">
    <div class="wallet-status">
      <div class="status-dot" id="statusDot"></div>
      <span id="statusText">æœªè¿æ¥é’±åŒ…</span>
    </div>
    <button class="wallet-btn" id="connectBtn" onclick="handleWalletClick()">è¿æ¥é’±åŒ…</button>
    <div class="wallet-info" id="walletInfo" style="display:none;">
      <span id="networkName">--</span>
      <span id="tokenBalance">ä½™é¢: åŠ è½½ä¸­...</span>
    </div>
  </div>

  <!-- é’±åŒ…é€‰æ‹©å¼¹çª— -->
  <div class="wallet-select" id="walletSelect" onclick="closeWalletSelect(event)">
    <div class="wallet-modal" onclick="event.stopPropagation()">
      <h3>é€‰æ‹©é’±åŒ…</h3>
      <div class="wallet-option" onclick="connectWallet('metamask')" id="metamaskOption" style="display:none;">
        <div style="background:#e2761b;">M</div>
        <div class="wallet-option-info">
          <div class="wallet-option-title">MetaMask</div>
          <div class="wallet-option-desc">æœ€æµè¡Œçš„ä»¥å¤ªåŠé’±åŒ…</div>
        </div>
      </div>
      <div class="wallet-option" onclick="connectWallet('coinbase')" id="coinbaseOption" style="display:none;">
        <div style="background:#0052ff;">C</div>
        <div class="wallet-option-info">
          <div class="wallet-option-title">Coinbase Wallet</div>
          <div class="wallet-option-desc">Coinbase å®˜æ–¹é’±åŒ…</div>
        </div>
      </div>
      <div class="wallet-option" onclick="connectWallet('tokenpocket')" id="tpOption" style="display:none;">
        <div style="background:#2980fe;">TP</div>
        <div class="wallet-option-info">
          <div class="wallet-option-title">TokenPocket</div>
          <div class="wallet-option-desc">å¤šé“¾æ•°å­—é’±åŒ…</div>
        </div>
      </div>
      <div class="wallet-option" onclick="connectWallet('generic')" id="genericOption">
        <div style="background:#10b981;">Web3</div>
        <div class="wallet-option-info">
          <div class="wallet-option-title">Web3 é’±åŒ…</div>
          <div class="wallet-option-desc">è¿æ¥å·²æ£€æµ‹åˆ°çš„é’±åŒ…æ‰©å±•</div>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="title">ğŸ”¥ è¸é©¬å°ç¥ ç‡ƒçƒ§åˆ†çº¢</div>
    <div class="subtitle">Burn To Earn | ç‡ƒçƒ§è·å–åˆ†çº¢æƒ</div>

    <div class="panel">
      <div>
        <div class="label">æˆ‘çš„å¯é¢†å–åˆ†çº¢</div>
        <div class="balance-tag" id="claimableUsd">â‰ˆ $0.00</div>
      </div>
      <div class="value" id="pending">0.00 BNB</div>
    </div>
    <div class="panel">
      <div class="label">æˆ‘å·²ç‡ƒçƒ§</div>
      <div class="value" id="myburn">0 è¸é©¬å°ç¥</div>
    </div>
    <div class="panel">
      <div class="label">å…¨ç½‘æ€»ç‡ƒçƒ§</div>
      <div class="value" id="totalburn">0 è¸é©¬å°ç¥</div>
    </div>

    <div class="input-box">
      <input id="amount" type="number" placeholder="è¾“å…¥ç‡ƒçƒ§æ•°é‡" min="0" step="0.01"/>
      <div class="balance-tag" style="text-align:right;margin-top:-8px;margin-bottom:8px;cursor:pointer;color:#3b82f6;" onclick="fillMax()">æœ€å¤§å¯ç”¨: <span id="maxAmount">0</span> è¸é©¬å°ç¥</div>
    </div>

    <button class="btn-burn" id="burnBtn" onclick="burn()">ğŸ”¥ ç«‹å³ç‡ƒçƒ§</button>
    <button class="btn-claim" id="claimBtn" onclick="claim()">ğŸ’° é¢†å–åˆ†çº¢</button>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/web3@1.10.3/dist/web3.min.js"></script>
<script>
const CONTRACT = "0x9a889E525FAEF4851bf5BEbfb5F294AC9D097777";

// ABI åŒ…å«æ ‡å‡† ERC20 balanceOf
const ABI = [
  {"inputs":[{"name":"amount","type":"uint256"}],"name":"burn","stateMutability":"nonpayable","type":"function"},
  {"inputs":[],"name":"claim","stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"name":"user","type":"address"}],"name":"claimable","outputs":[{"name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"name":"user","type":"address"}],"name":"burnAmount","outputs":[{"name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"totalBurned","outputs":[{"name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"}
];

let web3 = null;
let account = null;
let contract = null;
let currentProvider = null;

window.addEventListener('load', () => {
  detectWallets();
  if (localStorage.getItem('walletConnected') === 'true') {
    autoConnect();
  }
});

function detectWallets() {
  const hasMetaMask = window.ethereum?.isMetaMask || (window.ethereum?.providers?.some(p => p.isMetaMask));
  const hasCoinbase = window.ethereum?.isCoinbaseWallet || (window.ethereum?.providers?.some(p => p.isCoinbaseWallet));
  const hasTokenPocket = window.ethereum?.isTokenPocket;
  
  if (hasMetaMask) document.getElementById('metamaskOption').style.display = 'flex';
  if (hasCoinbase) document.getElementById('coinbaseOption').style.display = 'flex';
  if (hasTokenPocket) document.getElementById('tpOption').style.display = 'flex';
  document.getElementById('genericOption').style.display = 'flex';
}

function handleWalletClick() {
  if (account) {
    disconnectWallet();
  } else {
    document.getElementById('walletSelect').classList.add('show');
  }
}

function closeWalletSelect(e) {
  if (e.target === document.getElementById('walletSelect')) {
    document.getElementById('walletSelect').classList.remove('show');
  }
}

async function connectWallet(type) {
  try {
    let provider = null;
    
    if (window.ethereum) {
      if (window.ethereum.providers) {
        switch(type) {
          case 'metamask':
            provider = window.ethereum.providers.find(p => p.isMetaMask);
            break;
          case 'coinbase':
            provider = window.ethereum.providers.find(p => p.isCoinbaseWallet);
            break;
          case 'tokenpocket':
            provider = window.ethereum.providers.find(p => p.isTokenPocket);
            break;
          default:
            provider = window.ethereum;
        }
      } else {
        provider = window.ethereum;
      }
    }
    
    if (!provider) {
      alert('è¯·å®‰è£…é’±åŒ…æ‰©å±•æˆ–åˆ·æ–°é¡µé¢é‡è¯•');
      return;
    }
    
    currentProvider = provider;
    web3 = new Web3(provider);
    
    const accounts = await provider.request({ method: 'eth_requestAccounts' });
    account = accounts[0];
    
    localStorage.setItem('walletConnected', 'true');
    localStorage.setItem('walletType', type);
    
    contract = new web3.eth.Contract(ABI, CONTRACT);
    
    updateWalletUI();
    await loadData();
    setupListeners(provider);
    
    document.getElementById('walletSelect').classList.remove('show');
    
  } catch (err) {
    console.error('è¿æ¥å¤±è´¥:', err);
    alert('è¿æ¥å¤±è´¥: ' + (err.message || 'ç”¨æˆ·æ‹’ç»è¿æ¥'));
  }
}

async function autoConnect() {
  const type = localStorage.getItem('walletType') || 'generic';
  await connectWallet(type);
}

function disconnectWallet() {
  account = null;
  web3 = null;
  contract = null;
  currentProvider = null;
  localStorage.removeItem('walletConnected');
  localStorage.removeItem('walletType');
  
  document.getElementById('statusDot').classList.remove('connected');
  document.getElementById('statusText').textContent = 'æœªè¿æ¥é’±åŒ…';
  document.getElementById('connectBtn').textContent = 'è¿æ¥é’±åŒ…';
  document.getElementById('connectBtn').classList.remove('disconnect');
  document.getElementById('walletInfo').style.display = 'none';
  
  document.getElementById('pending').textContent = '0.00 BNB';
  document.getElementById('myburn').textContent = '0 è¸é©¬å°ç¥';
  document.getElementById('totalburn').textContent = '0 è¸é©¬å°ç¥';
  document.getElementById('tokenBalance').textContent = 'ä½™é¢: -- è¸é©¬å°ç¥';
}

async function updateWalletUI() {
  if (!account) return;
  
  const shortAddr = account.slice(0, 6) + '...' + account.slice(-4);
  document.getElementById('statusDot').classList.add('connected');
  document.getElementById('statusText').textContent = shortAddr;
  document.getElementById('connectBtn').textContent = 'æ–­å¼€è¿æ¥';
  document.getElementById('connectBtn').classList.add('disconnect');
  document.getElementById('walletInfo').style.display = 'flex';
  
  const chainId = await web3.eth.getChainId();
  const networkNames = {
    56: 'BSC Mainnet',
    97: 'BSC Testnet',
    1: 'Ethereum',
    5: 'Goerli'
  };
  document.getElementById('networkName').textContent = networkNames[chainId] || `ChainID: ${chainId}`;
}

async function loadData() {
  if (!contract || !account) return;
  
  // åˆ†åˆ«æŸ¥è¯¢ï¼Œäº’ä¸å¹²æ‰°
  await Promise.all([
    // 1. æŸ¥è¯¢å¯é¢†å–åˆ†çº¢
    contract.methods.claimable(account).call().then(claimable => {
      const claimableEth = web3.utils.fromWei(claimable, 'ether');
      document.getElementById('pending').textContent = parseFloat(claimableEth).toFixed(4) + ' BNB';
      document.getElementById('claimableUsd').textContent = 'â‰ˆ $' + (parseFloat(claimableEth) * 300).toFixed(2);
    }).catch(err => {
      console.log('claimable æŸ¥è¯¢å¤±è´¥:', err);
    }),
    
    // 2. æŸ¥è¯¢å·²ç‡ƒçƒ§æ•°é‡
    contract.methods.burnAmount(account).call().then(burned => {
      document.getElementById('myburn').textContent = web3.utils.fromWei(burned, 'ether') + ' è¸é©¬å°ç¥';
    }).catch(err => {
      console.log('burnAmount æŸ¥è¯¢å¤±è´¥:', err);
      document.getElementById('myburn').textContent = '0 è¸é©¬å°ç¥';
    }),
    
    // 3. æŸ¥è¯¢å…¨ç½‘æ€»ç‡ƒçƒ§
    contract.methods.totalBurned().call().then(total => {
      document.getElementById('totalburn').textContent = web3.utils.fromWei(total, 'ether') + ' è¸é©¬å°ç¥';
    }).catch(err => {
      console.log('totalBurned æŸ¥è¯¢å¤±è´¥:', err);
      document.getElementById('totalburn').textContent = '0 è¸é©¬å°ç¥';
    }),
    
    // 4. æŸ¥è¯¢ä»£å¸ä½™é¢
    contract.methods.balanceOf(account).call().then(balance => {
      const balanceEth = web3.utils.fromWei(balance, 'ether');
      document.getElementById('tokenBalance').textContent = `ä½™é¢: ${parseFloat(balanceEth).toFixed(2)} è¸é©¬å°ç¥`;
      document.getElementById('maxAmount').textContent = parseFloat(balanceEth).toFixed(2);
    }).catch(err => {
      console.error('balanceOf æŸ¥è¯¢å¤±è´¥:', err);
      document.getElementById('tokenBalance').textContent = 'ä½™é¢: æŸ¥è¯¢å¤±è´¥';
      document.getElementById('maxAmount').textContent = '0';
    })
  ]);
}

function setupListeners(provider) {
  provider.on('accountsChanged', (accounts) => {
    if (accounts.length === 0) {
      disconnectWallet();
    } else {
      account = accounts[0];
      updateWalletUI();
      loadData();
    }
  });
  
  provider.on('chainChanged', () => {
    window.location.reload();
  });
  
  provider.on('disconnect', () => {
    disconnectWallet();
  });
}

function fillMax() {
  const max = document.getElementById('maxAmount').textContent;
  if (max && max !== '0' && max !== 'æŸ¥è¯¢å¤±è´¥') {
    document.getElementById('amount').value = max;
  }
}

async function burn(){
  if (!account) {
    document.getElementById('walletSelect').classList.add('show');
    return;
  }
  
  const amt = document.getElementById("amount").value;
  if(!amt || amt <= 0) return alert("è¯·è¾“å…¥ç‡ƒçƒ§æ•°é‡");
  
  const btn = document.getElementById('burnBtn');
  btn.innerHTML = '<span class="loading"></span> å¤„ç†ä¸­...';
  btn.disabled = true;
  
  try {
    const val = web3.utils.toWei(amt, "ether");
    await contract.methods.burn(val).send({from: account})
      .on("transactionHash", h => {
        alert("æäº¤æˆåŠŸï¼Œç­‰å¾…ç¡®è®¤...\nHash: " + h.slice(0, 10) + "...");
      })
      .on("receipt", () => {
        alert("âœ… ç‡ƒçƒ§æˆåŠŸï¼è·å¾—åˆ†çº¢æƒ");
        loadData();
        document.getElementById("amount").value = '';
      });
  } catch (err) {
    alert('äº¤æ˜“å¤±è´¥: ' + (err.message || 'ç”¨æˆ·å–æ¶ˆ'));
  } finally {
    btn.innerHTML = 'ğŸ”¥ ç«‹å³ç‡ƒçƒ§';
    btn.disabled = false;
  }
}

async function claim(){
  if (!account) {
    document.getElementById('walletSelect').classList.add('show');
    return;
  }
  
  const btn = document.getElementById('claimBtn');
  btn.innerHTML = '<span class="loading"></span> é¢†å–ä¸­...';
  btn.disabled = true;
  
  try {
    await contract.methods.claim().send({from: account})
      .on("transactionHash", h => {
        alert("æäº¤æˆåŠŸï¼Œç­‰å¾…ç¡®è®¤...\nHash: " + h.slice(0, 10) + "...");
      })
      .on("receipt", () => {
        alert("âœ… åˆ†çº¢é¢†å–æˆåŠŸï¼");
        loadData();
      });
  } catch (err) {
    alert('é¢†å–å¤±è´¥: ' + (err.message || 'ç”¨æˆ·å–æ¶ˆ'));
  } finally {
    btn.innerHTML = 'ğŸ’° é¢†å–åˆ†çº¢';
    btn.disabled = false;
  }
}

setInterval(() => {
  if (account) loadData();
}, 10000);
</script>
</body>
</html>
