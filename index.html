<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#ffffff">
    <title>è¸é©¬å°ç¥æ–—åœ°ä¸»</title>
    
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script>
    <script src="abi.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", "PingFang SC", "Microsoft YaHei", sans-serif; 
            background: linear-gradient(180deg, #f8f9fa 0%, #ffffff 100%); 
            min-height: 100vh; 
            color: #1a1a1a; 
            overflow-x: hidden;
            padding-bottom: 90px;
        }
        
        @media (min-width: 768px) {
            body { display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; background: #f0f0f0; }
            .mobile-container { width: 100%; max-width: 480px; background: linear-gradient(180deg, #f8f9fa 0%, #ffffff 100%); min-height: 100vh; position: relative; box-shadow: 0 0 40px rgba(0,0,0,0.1); }
        }
        
        #homePage, #burnPage, #claimPage, #rankPage { min-height: 100vh; display: none; position: relative; }
        #homePage { display: block; animation: fadeIn 0.4s ease; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .top-nav { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); position: sticky; top: 0; z-index: 100; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .brand { font-size: 20px; font-weight: 800; letter-spacing: -0.5px; background: linear-gradient(135deg, #1a1a1a 0%, #4a4a4a 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .top-title { font-size: 18px; font-weight: 700; position: absolute; left: 50%; transform: translateX(-50%); }
        
        .back-btn { width: 36px; height: 36px; border-radius: 50%; background: rgba(0,0,0,0.05); border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; color: #1a1a1a; }
        
        .wallet-btn { width: 40px; height: 40px; border-radius: 50%; background: #1a1a1a; color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; border: none; font-size: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .wallet-btn.connected { background: linear-gradient(135deg, #00d26a 0%, #00a854 100%); }
        
        .container { max-width: 480px; margin: 0 auto; padding: 0 16px; }
        
        /* ä¸‰å¡ç‰‡å¸ƒå±€ */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin: 16px 0; }
        .stat-card { background: white; border-radius: 16px; padding: 16px 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.05); text-align: center; }
        .stat-label { font-size: 11px; color: #999; margin-bottom: 4px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.3px; }
        .stat-value { font-size: 16px; font-weight: 700; color: #1a1a1a; letter-spacing: -0.5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .stat-sub { font-size: 10px; color: #00a854; margin-top: 2px; font-weight: 600; }
        .stat-sub.ai { color: #8b5cf6; }
        
        /* ä»Šæ—¥å¸ä»· + åˆ†çº¢å¥–æ±  åŒæ¨¡å—å¸ƒå±€ */
        .price-pool-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 0 0 16px; }
        
        /* ä»Šæ—¥å¸ä»·æ¨¡å— */
        .price-module-full { 
            background: white; 
            border-radius: 20px; 
            padding: 20px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.05); 
            border: 1px solid rgba(0,0,0,0.05); 
            display: flex; 
            flex-direction: column;
            justify-content: center;
        }
        .price-header-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .price-title-text { font-size: 11px; color: #666; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .price-change-full { font-size: 11px; font-weight: 700; color: #00a854; background: rgba(0,168,84,0.1); padding: 3px 6px; border-radius: 10px; }
        .price-change-full.down { color: #dc2626; background: rgba(220,38,38,0.1); }
        .price-value-full { font-size: 22px; font-weight: 800; color: #1a1a1a; letter-spacing: -0.5px; }
        .price-loading { font-size: 12px; color: #999; }
        
        /* åˆ†çº¢å¥–æ± æ¨¡å— - ä¸AIå¥–æ± æ ·å¼ä¸€è‡´ */
        .dividend-pool-module { 
            background: linear-gradient(135deg, #fef3c7 0%, #fffbeb 100%); 
            border-radius: 20px; 
            padding: 20px; 
            box-shadow: 0 4px 20px rgba(245,158,11,0.1); 
            border: 1px solid rgba(245,158,11,0.2); 
            display: flex; 
            flex-direction: column;
            justify-content: center;
            text-align: center;
        }
        .dividend-pool-label { 
            font-size: 11px; 
            color: #92400e; 
            margin-bottom: 6px; 
            font-weight: 600; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
        }
        .dividend-pool-value { 
            font-size: 22px; 
            font-weight: 800; 
            color: #b45309; 
            letter-spacing: -0.5px; 
            margin-bottom: 2px;
        }
        .dividend-pool-sub { 
            font-size: 10px; 
            color: #d97706; 
            font-weight: 600; 
        }
        
        /* æ¸¸æˆå…¥å£ */
        .game-section-full { margin-bottom: 20px; }
        .game-module-full { 
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); 
            border-radius: 24px; 
            padding: 32px 24px; 
            color: white; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); 
            text-align: center; 
            position: relative; 
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s;
            text-decoration: none;
            display: block;
        }
        .game-module-full:active { transform: scale(0.98); }
        .game-module-full::before { content: 'â™ ï¸'; position: absolute; top: -10px; right: -10px; font-size: 80px; opacity: 0.05; }
        .game-module-full::after { content: 'â™¥ï¸'; position: absolute; bottom: -20px; left: -20px; font-size: 100px; opacity: 0.03; }
        
        .game-status-full { font-size: 11px; opacity: 0.8; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
        .game-title-full { font-size: 24px; font-weight: 800; margin-bottom: 6px; position: relative; z-index: 1; }
        .game-desc-full { font-size: 13px; opacity: 0.8; margin-bottom: 20px; position: relative; z-index: 1; }
        .play-btn-full { 
            background: white; 
            color: #1a1a1a; 
            border: none; 
            padding: 14px 32px; 
            border-radius: 24px; 
            font-size: 15px; 
            font-weight: 700; 
            cursor: pointer; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
            position: relative; 
            z-index: 1;
            display: inline-block;
            pointer-events: none;
        }
        
        /* ç‡ƒçƒ§é¡µé¢ */
        .input-card { background: white; border-radius: 24px; padding: 28px 20px; margin: 0 0 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); text-align: center; }
        .input-label { font-size: 13px; color: #999; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
        .big-input { width: 100%; border: none; font-size: 42px; font-weight: 700; text-align: center; color: #1a1a1a; outline: none; margin-bottom: 16px; font-family: inherit; }
        .big-input::placeholder { color: #ddd; }
        
        .quick-buttons { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; }
        .quick-btn { background: #f5f5f5; border: 2px solid transparent; color: #1a1a1a; padding: 10px 16px; border-radius: 14px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; user-select: none; }
        .quick-btn:active { transform: scale(0.95); background: #e5e5e5; }
        .quick-btn.active-long { background: #1a1a1a; color: white; border-color: #1a1a1a; }
        
        .action-btn { width: 100%; background: #1a1a1a; color: white; border: none; padding: 16px; border-radius: 16px; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.15); }
        .action-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .action-btn:active:not(:disabled) { transform: scale(0.98); }
        .action-btn.burn { background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); }
        .action-btn.claim { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 16px; }
        .info-card { background: #fafafa; border-radius: 14px; padding: 14px; text-align: center; }
        .info-label { font-size: 11px; color: #999; margin-bottom: 4px; font-weight: 500; }
        .info-value { font-size: 16px; font-weight: 700; color: #1a1a1a; }
        
        /* é¢†å–åˆ†çº¢é¡µé¢ */
        .claim-container { padding: 16px; }
        .claim-header { background: linear-gradient(135deg, #fffbeb 0%, #ffffff 100%); border: 1px solid rgba(245,158,11,0.2); border-radius: 20px; padding: 24px; text-align: center; margin-bottom: 16px; box-shadow: 0 4px 20px rgba(245,158,11,0.1); }
        .claim-label { font-size: 12px; color: #92400e; margin-bottom: 8px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
        .claim-amount { font-size: 36px; font-weight: 800; color: #b45309; margin-bottom: 4px; letter-spacing: -1px; }
        .claim-unit { font-size: 14px; color: #d97706; font-weight: 600; margin-bottom: 20px; }
        .claim-btn { width: 100%; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; padding: 14px; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 15px rgba(245,158,11,0.3); }
        .claim-btn:disabled { opacity: 0.5; background: #ccc; box-shadow: none; cursor: not-allowed; }
        
        .claim-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 16px; }
        .claim-stat-item { background: white; border-radius: 12px; padding: 12px 8px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .claim-stat-label { font-size: 10px; color: #999; margin-bottom: 4px; }
        .claim-stat-value { font-size: 13px; font-weight: 700; color: #1a1a1a; }
        
        .claim-rule { background: white; border-radius: 16px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); font-size: 12px; color: #666; line-height: 1.6; text-align: center; }
        .claim-rule-title { font-weight: 700; color: #1a1a1a; margin-bottom: 6px; font-size: 13px; }
        
        /* æ’è¡Œé¡µé¢ */
        .rank-header { padding: 60px 20px 20px; text-align: center; background: linear-gradient(180deg, #fafafa 0%, #ffffff 100%); }
        .rank-title { font-size: 28px; font-weight: 800; margin-bottom: 4px; }
        .rank-subtitle { font-size: 14px; color: #666; }
        
        .rank-tabs { display: flex; padding: 0 20px; margin-bottom: 16px; gap: 10px; }
        .rank-tab { flex: 1; padding: 12px; border-radius: 12px; border: none; background: #f5f5f5; font-size: 14px; font-weight: 600; color: #666; cursor: pointer; }
        .rank-tab.active { background: #1a1a1a; color: white; }
        
        .rank-list { padding: 0 16px; min-height: 300px; }
        .rank-item { display: flex; align-items: center; padding: 12px 16px; background: white; border-radius: 16px; margin-bottom: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .rank-number { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; margin-right: 12px; background: #f5f5f5; color: #666; }
        .rank-number.top1 { background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); color: #8b6914; }
        .rank-number.top2 { background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%); color: #666; }
        .rank-number.top3 { background: linear-gradient(135deg, #cd7f32 0%, #daa520 100%); color: white; }
        
        .rank-info { flex: 1; }
        .rank-address { font-size: 14px; font-weight: 600; color: #1a1a1a; margin-bottom: 2px; }
        .rank-amount { font-size: 12px; color: #666; }
        .rank-reward { font-size: 14px; font-weight: 700; color: #00a854; }
        
        .rank-loading { text-align: center; padding: 40px; color: #999; }
        .rank-empty { text-align: center; padding: 40px; color: #999; }
        
        .my-rank { position: fixed; bottom: 90px; left: 16px; right: 16px; background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); color: white; padding: 16px 20px; border-radius: 16px; display: flex; align-items: center; box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
        .my-rank-label { font-size: 12px; opacity: 0.8; margin-bottom: 2px; }
        .my-rank-value { font-size: 16px; font-weight: 700; }
        
        /* åº•éƒ¨å¯¼èˆª */
        .bottom-nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(255,255,255,0.98); backdrop-filter: blur(20px); border-radius: 30px; padding: 10px 14px; display: flex; gap: 6px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); border: 1px solid rgba(0,0,0,0.05); z-index: 1000; max-width: 95%; }
        @media (min-width: 768px) { .bottom-nav { position: absolute; } }
        
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 3px; padding: 8px 14px; border-radius: 18px; cursor: pointer; transition: all 0.3s; min-width: 56px; color: #999; font-size: 10px; font-weight: 600; border: none; background: transparent; }
        .nav-item.active { background: #1a1a1a; color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .nav-icon { font-size: 18px; line-height: 1; }
        
        /* æç¤º */
        .tx-toast { position: fixed; top: 100px; left: 50%; transform: translateX(-50%); background: rgba(26,26,26,0.95); color: white; padding: 14px 24px; border-radius: 14px; font-size: 14px; font-weight: 500; z-index: 10000; display: none; backdrop-filter: blur(10px); box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-width: 90%; text-align: center; }
        .tx-toast.show { display: block; }
        .tx-toast.error { background: rgba(220,38,38,0.95); }
        
        .loading { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .network-badge { position: fixed; top: 60px; left: 50%; transform: translateX(-50%); background: #1a1a1a; color: white; padding: 10px 20px; border-radius: 20px; font-size: 13px; font-weight: 600; z-index: 9999; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .network-badge.show { display: block; }
        
        .warning-box { background: #fffbeb; border: 1px solid #f59e0b; border-radius: 14px; padding: 14px; margin: 16px; font-size: 13px; color: #92400e; }
        
        .auth-section { position: fixed; top: 80px; right: 16px; z-index: 100; }
        @media (min-width: 768px) { .auth-section { position: absolute; } }
        .auth-btn { background: #1a1a1a; color: white; border: none; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .auth-btn.authorized { background: #00d26a; }
    </style>
</head>
<body>
    <div class="mobile-container">
        <div id="networkBadge" class="network-badge">è¯·åˆ‡æ¢ç½‘ç»œ</div>
        <div id="txToast" class="tx-toast"></div>

        <!-- é¦–é¡µ -->
        <div id="homePage">
            <div class="top-nav">
                <div class="brand">è¸é©¬å°ç¥</div>
                <button class="wallet-btn" id="walletBtn" onclick="connectWallet()">ğŸ’¼</button>
            </div>
            
            <div id="authSection" class="auth-section" style="display: none;">
                <button class="auth-btn" id="authBtn" onclick="authorizeToken()">æˆæƒ</button>
            </div>

            <div class="container">
                <!-- ç¬¬ä¸€è¡Œï¼šä½™é¢ + ç‡ƒçƒ§ç§¯åˆ† + AIæ±  -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">æˆ‘çš„ä½™é¢</div>
                        <div class="stat-value" id="balance">0.00</div>
                        <div class="stat-sub" id="tokenSymbolDisplay">TMFS</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ç‡ƒçƒ§ç§¯åˆ†</div>
                        <div class="stat-value" id="burnPoints">0.00</div>
                        <div class="stat-sub">åˆ†çº¢æƒé‡</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">AIå¥–æ± </div>
                        <div class="stat-value" id="aiPoolAmount">0.00</div>
                        <div class="stat-sub ai">æ¸¸æˆå¥–åŠ±</div>
                    </div>
                </div>

                <!-- ç¬¬äºŒè¡Œï¼šä»Šæ—¥å¸ä»· + åˆ†çº¢å¥–æ± ï¼ˆåŒæ¨¡å—å¹¶è¡Œï¼‰ -->
                <div class="price-pool-grid">
                    <!-- ä»Šæ—¥å¸ä»· -->
                    <div class="price-module-full">
                        <div class="price-header-row">
                            <div class="price-title-text">ä»Šæ—¥å¸ä»·</div>
                            <div class="price-change-full" id="priceChange">--</div>
                        </div>
                        <div class="price-value-full" id="tokenPrice">
                            <span class="price-loading">åŠ è½½ä¸­...</span>
                        </div>
                    </div>
                    
                    <!-- åˆ†çº¢å¥–æ±  -->
                    <div class="dividend-pool-module">
                        <div class="dividend-pool-label">ğŸ’° åˆ†çº¢å¥–æ± </div>
                        <div class="dividend-pool-value" id="dividendPoolAmount">0.0000</div>
                        <div class="dividend-pool-sub">WBNB å¾…åˆ†é…</div>
                    </div>
                </div>

                <!-- ç¬¬ä¸‰è¡Œï¼šæ¸¸æˆå…¥å£ -->
                <div class="game-section-full">
                    <a href="game.html" class="game-module-full" onclick="return checkWalletBeforeGame()">
                        <div class="game-status-full">ğŸ”¥ çƒ­é—¨å¯¹æˆ˜</div>
                        <div class="game-title-full">å¼€å§‹æ–—åœ°ä¸»</div>
                        <div class="game-desc-full">1v2 AIå¯¹æˆ˜ | èµ¢å–ä»£å¸å¥–åŠ±</div>
                        <button class="play-btn-full">ç«‹å³å¼€å§‹</button>
                    </a>
                </div>
            </div>
        </div>

        <!-- ç‡ƒçƒ§é¡µé¢ -->
        <div id="burnPage">
            <div class="top-nav">
                <button class="back-btn" onclick="showPage('home')">â†</button>
                <div class="top-title">ç‡ƒçƒ§ä»£å¸</div>
                <div style="width: 40px;"></div>
            </div>

            <div class="container" style="padding-top: 20px;">
                <div class="input-card">
                    <div class="input-label">ç‡ƒçƒ§æ•°é‡ (TMFS)</div>
                    <input type="number" class="big-input" id="burnAmountInput" placeholder="0" value="0">
                    
                    <div class="quick-buttons">
                        <button class="quick-btn" ontouchstart="startLongPress(this, 1000)" ontouchend="endLongPress()" onmousedown="startLongPress(this, 1000)" onmouseup="endLongPress()" onmouseleave="endLongPress()">+1k</button>
                        <button class="quick-btn" ontouchstart="startLongPress(this, 10000)" ontouchend="endLongPress()" onmousedown="startLongPress(this, 10000)" onmouseup="endLongPress()" onmouseleave="endLongPress()">+1w</button>
                        <button class="quick-btn" ontouchstart="startLongPress(this, 100000)" ontouchend="endLongPress()" onmousedown="startLongPress(this, 100000)" onmouseup="endLongPress()" onmouseleave="endLongPress()">+10w</button>
                    </div>
                    
                    <button class="action-btn burn" onclick="burnTokens()" id="burnBtn">ç¡®è®¤é”€æ¯</button>
                </div>

                <div class="info-grid">
                    <div class="info-card">
                        <div class="info-label">æˆ‘çš„ç´¯è®¡ç‡ƒçƒ§</div>
                        <div class="info-value" id="myTotalBurned">0</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">å…¨çƒç‡ƒçƒ§æ€»é‡</div>
                        <div class="info-value" id="globalBurned">0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- é¢†å–åˆ†çº¢é¡µé¢ -->
        <div id="claimPage">
            <div class="top-nav">
                <button class="back-btn" onclick="showPage('home')">â†</button>
                <div class="top-title">é¢†å–åˆ†çº¢</div>
                <div style="width: 40px;"></div>
            </div>

            <div class="claim-container">
                <div class="claim-header">
                    <div class="claim-label">å¯é¢†å– WBNB</div>
                    <div class="claim-amount" id="pendingWBNB">0.0000</div>
                    <div class="claim-unit">WBNB</div>
                    <button class="claim-btn" id="claimBtn" onclick="claimDividend()" disabled>é¢†å–åˆ†çº¢</button>
                </div>

                <div class="claim-stats">
                    <div class="claim-stat-item">
                        <div class="claim-stat-label">å·²é¢†å–</div>
                        <div class="claim-stat-value" id="totalClaimedWBNB">0</div>
                    </div>
                    <div class="claim-stat-item">
                        <div class="claim-stat-label">ç§¯åˆ†</div>
                        <div class="claim-stat-value" id="dividendPoints">0</div>
                    </div>
                    <div class="claim-stat-item">
                        <div class="claim-stat-label">æˆ‘çš„ç‡ƒçƒ§</div>
                        <div class="claim-stat-value" id="myBurnAmount">0</div>
                    </div>
                    <div class="claim-stat-item">
                        <div class="claim-stat-label">å…¨çƒç‡ƒçƒ§</div>
                        <div class="claim-stat-value" id="globalBurnAmount">0</div>
                    </div>
                </div>

                <div class="claim-rule">
                    <div class="claim-rule-title">ğŸ’¡ åˆ†çº¢è§„åˆ™</div>
                    é”€æ¯ TMFS è·å¾—åˆ†çº¢ç§¯åˆ†ï¼Œæ¯æ—¥æŒ‰ç§¯åˆ†å æ¯”åˆ†é… WBNBï¼Œå¯éšæ—¶é¢†å–
                </div>
            </div>
        </div>

        <!-- æ’è¡Œé¡µé¢ -->
        <div id="rankPage">
            <div class="rank-header">
                <div class="rank-title">ğŸ† ç‡ƒçƒ§æ’è¡Œ</div>
                <div class="rank-subtitle">å…¨çƒ TMFS ç‡ƒçƒ§é‡æ’è¡Œæ¦œ</div>
            </div>

            <div class="rank-tabs">
                <button class="rank-tab active" onclick="switchRankTab('burn')" data-tab="burn">ç‡ƒçƒ§æ’è¡Œ</button>
                <button class="rank-tab" onclick="switchRankTab('reward')" data-tab="reward">æ”¶ç›Šæ’è¡Œ</button>
            </div>

            <div class="rank-list" id="rankList">
                <div class="rank-loading">åŠ è½½ä¸­...</div>
            </div>

            <div class="my-rank">
                <div style="flex: 1;">
                    <div class="my-rank-label">æˆ‘çš„æ’å</div>
                    <div class="my-rank-value" id="myRank">åŠ è½½ä¸­...</div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 12px; opacity: 0.8;">é¢„è®¡æ”¶ç›Š</div>
                    <div style="font-size: 16px; font-weight: 700;" id="myRankReward">--</div>
                </div>
            </div>
        </div>

        <!-- åº•éƒ¨å¯¼èˆª -->
        <div class="bottom-nav">
            <button class="nav-item active" onclick="showPage('home')" data-page="home">
                <span class="nav-icon">ğŸ </span>
                <span>é¦–é¡µ</span>
            </button>
            <button class="nav-item" onclick="showPage('burn')" data-page="burn">
                <span class="nav-icon">ğŸ”¥</span>
                <span>ç‡ƒçƒ§</span>
            </button>
            <button class="nav-item" onclick="showPage('claim')" data-page="claim">
                <span class="nav-icon">ğŸ’</span>
                <span>é¢†åˆ†çº¢</span>
            </button>
            <button class="nav-item" onclick="showPage('rank')" data-page="rank">
                <span class="nav-icon">ğŸ†</span>
                <span>æ’è¡Œ</span>
            </button>
        </div>
    </div>

    <script>
        // ==================== é…ç½®åŠ è½½ ====================
        if (!window.CONTRACT_CONFIG) {
            alert('é”™è¯¯ï¼šæœªæ‰¾åˆ° abi.js æ–‡ä»¶ï¼');
            throw new Error('CONTRACT_CONFIG not found');
        }

        const CONFIG = window.CONTRACT_CONFIG;
        
        const TOKEN_ADDRESS = CONFIG.tokenAddress;
        const DIVIDEND_ADDRESS = CONFIG.dividendAddress;
        const GAME_ADDRESS = CONFIG.gameAddress;
        
        const TOKEN_ABI = CONFIG.tokenABI || [];
        const DIVIDEND_ABI = CONFIG.dividendABI || [];
        const GAME_ABI = CONFIG.gameABI || [];
        
        const CHAIN_ID = CONFIG.chainId || "0x38";
        const CHAIN_NAME = CONFIG.chainName || "BSC Mainnet";
        const RPC_URL = CONFIG.rpcUrl || "https://bsc-dataseed.binance.org/";
        const TOKEN_DECIMALS = CONFIG.decimals || 18;
        const TOKEN_SYMBOL = CONFIG.symbol || "TMFS";
        
        const HAS_TOKEN_CONTRACT = TOKEN_ADDRESS && TOKEN_ABI.length > 0;
        const HAS_DIVIDEND_CONTRACT = DIVIDEND_ADDRESS && DIVIDEND_ABI.length > 0;
        const HAS_GAME_CONTRACT = GAME_ADDRESS && GAME_ABI.length > 0;

        // WBNB åˆçº¦åœ°å€ (BSCä¸»ç½‘)
        const WBNB_ADDRESS = "0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c";

        // ==================== å…¨å±€å˜é‡ ====================
        let provider = null;
        let signer = null;
        let tokenContract = null;
        let dividendContract = null;
        let gameContract = null;
        let wbnbContract = null; // WBNBåˆçº¦å®ä¾‹
        let userAddress = null;
        let longPressTimer = null;
        let longPressInterval = null;
        const LONG_PRESS_DELAY = 500;

        // ==================== å·¥å…·å‡½æ•° ====================
        function showToast(message, isError = false) {
            const toast = document.getElementById('txToast');
            toast.textContent = message;
            toast.className = 'tx-toast ' + (isError ? 'error' : '') + ' show';
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function formatAddress(address) {
            if (!address || address === '0x0000000000000000000000000000000000000000') return 'æ— ';
            return address.slice(0, 6) + '...' + address.slice(-4);
        }

        function formatAmount(amount, decimals = 2) {
            if (!amount || amount === '0' || amount == 0) return '0.00';
            return parseFloat(amount).toFixed(decimals);
        }

        // ==================== çœŸå®å¸ä»·è·å– ====================
        async function fetchTokenPrice() {
            try {
                const response = await fetch(
                    `https://api.dexscreener.com/latest/dex/tokens/${TOKEN_ADDRESS}`
                );
                
                if (!response.ok) throw new Error('ä»·æ ¼APIè¯·æ±‚å¤±è´¥');
                
                const data = await response.json();
                
                if (data.pairs && data.pairs.length > 0) {
                    const pair = data.pairs[0];
                    const price = parseFloat(pair.priceUsd);
                    const priceChange24h = parseFloat(pair.priceChange?.h24 || 0);
                    
                    document.getElementById('tokenPrice').textContent = '$' + price.toFixed(6);
                    
                    const changeEl = document.getElementById('priceChange');
                    const changeText = (priceChange24h >= 0 ? '+' : '') + priceChange24h.toFixed(2) + '%';
                    changeEl.textContent = changeText;
                    changeEl.className = 'price-change-full ' + (priceChange24h < 0 ? 'down' : '');
                } else {
                    throw new Error('æœªæ‰¾åˆ°äº¤æ˜“å¯¹');
                }
                
            } catch (error) {
                console.error('è·å–ä»·æ ¼å¤±è´¥:', error);
                document.getElementById('tokenPrice').textContent = '$--';
                document.getElementById('priceChange').textContent = '--';
            }
        }

        // ==================== åˆ†çº¢å¥–æ±  - çœŸå®WBNBæ•°é‡ ====================
        async function loadDividendPoolData() {
            try {
                let poolWBNB = '0.0000';
                
                if (HAS_DIVIDEND_CONTRACT && dividendContract && wbnbContract) {
                    // æŸ¥è¯¢åˆ†çº¢åˆçº¦ä¸­çš„WBNBä½™é¢
                    const wbnbBalance = await wbnbContract.balanceOf(DIVIDEND_ADDRESS);
                    poolWBNB = ethers.formatEther(wbnbBalance);
                    
                    console.log('åˆ†çº¢å¥–æ± WBNB:', poolWBNB);
                } else {
                    console.log('åˆ†çº¢åˆçº¦æœªé…ç½®ï¼Œæ— æ³•è¯»å–å¥–æ± ');
                }
                
                document.getElementById('dividendPoolAmount').textContent = formatAmount(poolWBNB, 4);
                
            } catch (error) {
                console.error('åŠ è½½åˆ†çº¢å¥–æ± å¤±è´¥:', error);
                document.getElementById('dividendPoolAmount').textContent = '0.0000';
            }
        }

        // ==================== AIå¥–æ±  ====================
        async function loadAIPoolData() {
            try {
                let aiPoolBalance = '0.00';
                
                if (HAS_GAME_CONTRACT && gameContract) {
                    const poolBalance = await gameContract.getAIPoolBalance().catch(() => 0);
                    aiPoolBalance = ethers.formatUnits(poolBalance, TOKEN_DECIMALS);
                }
                
                document.getElementById('aiPoolAmount').textContent = formatAmount(aiPoolBalance);
                
            } catch (error) {
                console.error('åŠ è½½AIå¥–æ± å¤±è´¥:', error);
                document.getElementById('aiPoolAmount').textContent = '0.00';
            }
        }

        // ==================== æ¸¸æˆå…¥å£æ£€æŸ¥ ====================
        function checkWalletBeforeGame() {
            if (!userAddress) {
                showToast('è¯·å…ˆè¿æ¥é’±åŒ…', true);
                return false;
            }
            if (!HAS_GAME_CONTRACT) {
                showToast('æ¸¸æˆåˆçº¦å°šæœªéƒ¨ç½²', true);
                return false;
            }
            return true;
        }

        // ==================== é•¿æŒ‰åŠŸèƒ½ ====================
        function startLongPress(btn, amount) {
            btn.classList.add('active-long');
            addToBurnInput(amount);
            
            longPressTimer = setTimeout(() => {
                longPressInterval = setInterval(() => {
                    addToBurnInput(amount);
                }, 100);
            }, LONG_PRESS_DELAY);
        }

        function endLongPress() {
            if (longPressTimer) { clearTimeout(longPressTimer); longPressTimer = null; }
            if (longPressInterval) { clearInterval(longPressInterval); longPressInterval = null; }
            document.querySelectorAll('.quick-btn').forEach(btn => btn.classList.remove('active-long'));
        }

        function addToBurnInput(amount) {
            const input = document.getElementById('burnAmountInput');
            const current = parseFloat(input.value) || 0;
            input.value = current + amount;
        }

        // ==================== é’±åŒ…è¿æ¥ ====================
        async function connectWallet() {
            if (!window.ethereum) { 
                alert('è¯·å®‰è£… MetaMaskï¼'); 
                return; 
            }
            
            const btn = document.getElementById('walletBtn');
            btn.innerHTML = '<span class="loading"></span>';
            
            try {
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                if (chainId !== CHAIN_ID) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: CHAIN_ID }]
                        });
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: CHAIN_ID,
                                    chainName: CHAIN_NAME,
                                    rpcUrls: [RPC_URL]
                                }]
                            });
                        }
                    }
                }
                
                provider = new ethers.BrowserProvider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = await provider.getSigner();
                userAddress = await signer.getAddress();
                
                // åˆå§‹åŒ–åˆçº¦
                if (HAS_TOKEN_CONTRACT) {
                    tokenContract = new ethers.Contract(TOKEN_ADDRESS, TOKEN_ABI, signer);
                }
                if (HAS_DIVIDEND_CONTRACT) {
                    dividendContract = new ethers.Contract(DIVIDEND_ADDRESS, DIVIDEND_ABI, signer);
                }
                if (HAS_GAME_CONTRACT) {
                    gameContract = new ethers.Contract(GAME_ADDRESS, GAME_ABI, signer);
                }
                
                // åˆå§‹åŒ–WBNBåˆçº¦ï¼ˆç”¨äºæŸ¥è¯¢åˆ†çº¢å¥–æ± ä½™é¢ï¼‰
                // WBNBæ˜¯æ ‡å‡†ERC20ï¼Œä½¿ç”¨ç®€åŒ–ABI
                const wbnbABI = [
                    "function balanceOf(address account) view returns (uint256)",
                    "function decimals() view returns (uint8)",
                    "function symbol() view returns (string)"
                ];
                wbnbContract = new ethers.Contract(WBNB_ADDRESS, wbnbABI, signer);
                
                btn.classList.add('connected');
                btn.innerHTML = 'âœ“';
                document.getElementById('authSection').style.display = 'block';
                document.getElementById('tokenSymbolDisplay').textContent = TOKEN_SYMBOL;
                
                await loadAllData();
                showToast(`å·²è¿æ¥: ${TOKEN_SYMBOL}`);
                
            } catch (error) {
                console.error('è¿æ¥å¤±è´¥:', error);
                btn.innerHTML = 'ğŸ’¼';
                showToast('è¿æ¥å¤±è´¥: ' + error.message, true);
            }
        }

        // ==================== æ•°æ®åŠ è½½ ====================
        async function loadAllData() {
            if (!userAddress) return;
            
            try {
                if (HAS_TOKEN_CONTRACT && tokenContract) {
                    const balance = await tokenContract.balanceOf(userAddress);
                    document.getElementById('balance').textContent = formatAmount(
                        ethers.formatUnits(balance, TOKEN_DECIMALS)
                    );
                }
                
                await loadDividendData();
                await loadDividendPoolData(); // åŠ è½½åˆ†çº¢å¥–æ± 
                await loadAIPoolData();
                await checkAllowance();
                await fetchTokenPrice();
                
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
            }
        }

        async function checkAllowance() {
            if (!HAS_TOKEN_CONTRACT || !tokenContract || !userAddress) return;
            
            try {
                const spender = HAS_DIVIDEND_CONTRACT ? DIVIDEND_ADDRESS : TOKEN_ADDRESS;
                const allowance = await tokenContract.allowance(userAddress, spender);
                const btn = document.getElementById('authBtn');
                
                if (allowance > 0) { 
                    btn.textContent = 'å·²æˆæƒ'; 
                    btn.classList.add('authorized'); 
                } else {
                    btn.textContent = 'æˆæƒ';
                    btn.classList.remove('authorized');
                }
            } catch (error) { 
                console.error('æ£€æŸ¥æˆæƒå¤±è´¥:', error); 
            }
        }

        async function authorizeToken() {
            if (!HAS_TOKEN_CONTRACT || !tokenContract || !userAddress) { 
                showToast('è¯·å…ˆè¿æ¥é’±åŒ…', true); 
                return; 
            }
            
            const btn = document.getElementById('authBtn');
            const originalText = btn.textContent;
            btn.innerHTML = '<span class="loading"></span>';
            btn.disabled = true;
            
            try {
                const spender = HAS_DIVIDEND_CONTRACT ? DIVIDEND_ADDRESS : TOKEN_ADDRESS;
                const tx = await tokenContract.approve(spender, ethers.MaxUint256);
                showToast('æˆæƒäº¤æ˜“å·²å‘é€...');
                await tx.wait();
                showToast('æˆæƒæˆåŠŸï¼');
                await checkAllowance();
            } catch (error) {
                showToast('æˆæƒå¤±è´¥: ' + error.message, true);
                btn.textContent = originalText;
            } finally { 
                btn.disabled = false; 
            }
        }

        // ==================== ç‡ƒçƒ§åŠŸèƒ½ ====================
        async function burnTokens() {
            if (!HAS_DIVIDEND_CONTRACT || !dividendContract) { 
                showToast('æœªé…ç½®åˆ†çº¢åˆçº¦', true); 
                return; 
            }
            
            const amount = document.getElementById('burnAmountInput').value;
            if (!amount || amount <= 0) { 
                showToast('è¯·è¾“å…¥æœ‰æ•ˆæ•°é‡', true); 
                return; 
            }
            
            const btn = document.getElementById('burnBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> å¤„ç†ä¸­...';
            
            try {
                const amountWei = ethers.parseUnits(amount.toString(), TOKEN_DECIMALS);
                
                const balance = await tokenContract.balanceOf(userAddress);
                if (balance < amountWei) throw new Error('ä½™é¢ä¸è¶³');
                
                const allowance = await tokenContract.allowance(userAddress, DIVIDEND_ADDRESS);
                if (allowance < amountWei) {
                    showToast('æ­£åœ¨æˆæƒ...');
                    const approveTx = await tokenContract.approve(DIVIDEND_ADDRESS, ethers.MaxUint256);
                    await approveTx.wait();
                }
                
                const tx = await dividendContract.recordBurn(amountWei);
                showToast('é”€æ¯äº¤æ˜“å·²å‘é€...');
                await tx.wait();
                
                await loadAllData();
                document.getElementById('burnAmountInput').value = '0';
                showToast(`æˆåŠŸé”€æ¯ ${amount} ${TOKEN_SYMBOL}ï¼`);
                
            } catch (error) {
                showToast('é”€æ¯å¤±è´¥: ' + error.message, true);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'ç¡®è®¤é”€æ¯';
            }
        }

        // ==================== åˆ†çº¢åŠŸèƒ½ ====================
        async function loadDividendData() {
            if (!HAS_DIVIDEND_CONTRACT || !dividendContract || !userAddress) {
                document.getElementById('burnPoints').textContent = '0.00';
                return;
            }
            
            try {
                const claimableAmount = await dividendContract.claimable(userAddress).catch(() => 0);
                const userBurned = await dividendContract.userBurned(userAddress).catch(() => 0);
                const userClaimed = await dividendContract.userClaimed(userAddress).catch(() => 0);
                const totalBurned = await dividendContract.totalBurned().catch(() => 0);
                
                const claimableWBNB = ethers.formatEther(claimableAmount);
                const userBurnedFormatted = ethers.formatUnits(userBurned, TOKEN_DECIMALS);
                
                document.getElementById('burnPoints').textContent = formatAmount(userBurnedFormatted);
                document.getElementById('pendingWBNB').textContent = formatAmount(claimableWBNB, 4);
                document.getElementById('totalClaimedWBNB').textContent = formatAmount(ethers.formatEther(userClaimed), 4);
                document.getElementById('dividendPoints').textContent = formatAmount(userBurnedFormatted);
                document.getElementById('myBurnAmount').textContent = formatAmount(userBurnedFormatted);
                document.getElementById('globalBurnAmount').textContent = formatAmount(
                    ethers.formatUnits(totalBurned, TOKEN_DECIMALS)
                );
                document.getElementById('myTotalBurned').textContent = formatAmount(userBurnedFormatted);
                document.getElementById('globalBurned').textContent = formatAmount(
                    ethers.formatUnits(totalBurned, TOKEN_DECIMALS)
                );
                
                document.getElementById('claimBtn').disabled = claimableAmount <= 0;
                
            } catch (error) { 
                console.error('åŠ è½½åˆ†çº¢æ•°æ®å¤±è´¥:', error); 
            }
        }

        async function claimDividend() {
            if (!HAS_DIVIDEND_CONTRACT || !dividendContract) { 
                showToast('æœªé…ç½®åˆ†çº¢åˆçº¦', true); 
                return; 
            }
            
            const btn = document.getElementById('claimBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span>';
            
            try {
                const tx = await dividendContract.claim();
                showToast('é¢†å–äº¤æ˜“å·²å‘é€...');
                await tx.wait();
                await loadDividendData();
                await loadDividendPoolData(); // åˆ·æ–°å¥–æ± 
                showToast('WBNBåˆ†çº¢é¢†å–æˆåŠŸï¼');
            } catch (error) {
                showToast('é¢†å–å¤±è´¥: ' + error.message, true);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'é¢†å–åˆ†çº¢';
            }
        }

        // ==================== æ’è¡ŒåŠŸèƒ½ ====================
        async function loadRankData() {
            const rankList = document.getElementById('rankList');
            
            if (!HAS_DIVIDEND_CONTRACT || !dividendContract) {
                rankList.innerHTML = '<div class="rank-empty">æ’è¡Œæ•°æ®æš‚æ—¶æ— æ³•åŠ è½½</div>';
                return;
            }
            
            rankList.innerHTML = '<div class="rank-loading">åŠ è½½æ’è¡Œæ•°æ®...</div>';
            
            try {
                rankList.innerHTML = `
                    <div class="rank-empty">
                        <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“Š</div>
                        <div>æ’è¡ŒåŠŸèƒ½å¼€å‘ä¸­</div>
                        <div style="font-size: 12px; margin-top: 8px; opacity: 0.7;">
                            æ¸¸æˆåˆçº¦éƒ¨ç½²åå°†æ˜¾ç¤ºçœŸå®æ’è¡Œæ•°æ®
                        </div>
                    </div>
                `;
                
                const userBurned = await dividendContract.userBurned(userAddress).catch(() => 0);
                const totalBurned = await dividendContract.totalBurned().catch(() => 0);
                
                const myBurnAmount = ethers.formatUnits(userBurned, TOKEN_DECIMALS);
                const globalBurnAmount = ethers.formatUnits(totalBurned, TOKEN_DECIMALS);
                
                let rank = '99+';
                if (myBurnAmount > 0 && globalBurnAmount > 0) {
                    const ratio = parseFloat(myBurnAmount) / parseFloat(globalBurnAmount);
                    rank = '~' + Math.ceil(100 / (ratio * 100 + 1));
                }
                
                document.getElementById('myRank').textContent = `ç¬¬ ${rank} å | ç‡ƒçƒ§ ${formatAmount(myBurnAmount)} TMFS`;
                document.getElementById('myRankReward').textContent = formatAmount(
                    ethers.formatEther(await dividendContract.claimable(userAddress).catch(() => 0)), 4
                ) + ' BNB';
                
            } catch (error) {
                console.error('åŠ è½½æ’è¡Œå¤±è´¥:', error);
                rankList.innerHTML = '<div class="rank-empty">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</div>';
            }
        }

        function switchRankTab(tab) {
            document.querySelectorAll('.rank-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
        }

        // ==================== é¡µé¢åˆ‡æ¢ ====================
        function showPage(page) {
            ['homePage', 'burnPage', 'claimPage', 'rankPage'].forEach(id => {
                document.getElementById(id).style.display = 'none';
            });
            
            const pageMap = { 
                'home': 'homePage', 
                'burn': 'burnPage', 
                'claim': 'claimPage', 
                'rank': 'rankPage' 
            };
            
            if (pageMap[page]) {
                document.getElementById(pageMap[page]).style.display = 'block';
            }
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`.nav-item[data-page="${page}"]`)?.classList.add('active');
            
            if (page === 'claim' || page === 'burn') {
                if (userAddress) { loadAllData(); }
            } else if (page === 'rank') {
                loadRankData();
            }
        }

        // ==================== åˆå§‹åŒ– ====================
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', () => location.reload());
            window.ethereum.on('chainChanged', () => location.reload());
        }

        window.addEventListener('load', () => {
            console.log('âœ… DApp å·²åŠ è½½');
            fetchTokenPrice();
            setInterval(fetchTokenPrice, 30000);
        });
    </script>
</body>
</html>
