<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#ffffff">
    <title>è¸é©¬å°ç¥ç‡ƒçƒ§æ± </title> 
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script>
    <script src="abi.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", "PingFang SC", "Microsoft YaHei", sans-serif; 
            background: linear-gradient(180deg, #f8f9fa 0%, #ffffff 100%); 
            min-height: 100vh; 
            color: #1a1a1a; 
            overflow-x: hidden;
            padding-bottom: 90px;
        }
        
        @media (min-width: 768px) {
            body { display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; background: #f0f0f0; }
            .mobile-container { width: 100%; max-width: 480px; background: linear-gradient(180deg, #f8f9fa 0%, #ffffff 100%); min-height: 100vh; position: relative; box-shadow: 0 0 40px rgba(0,0,0,0.1); }
        }
        
        #homePage, #burnPage, #claimPage, #rankPage { min-height: 100vh; display: none; position: relative; }
        #homePage { display: block; animation: fadeIn 0.4s ease; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .top-nav { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 16px 20px; 
            background: rgba(255,255,255,0.95); 
            backdrop-filter: blur(20px); 
            position: sticky; 
            top: 0; 
            z-index: 100; 
            border-bottom: 1px solid rgba(0,0,0,0.05); 
        }
        .brand { font-size: 20px; font-weight: 800; letter-spacing: -0.5px; background: linear-gradient(135deg, #1a1a1a 0%, #4a4a4a 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .wallet-area { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 8px;
        }
        .wallet-btn { 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            background: #1a1a1a; 
            color: white; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            border: none; 
            font-size: 16px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
            transition: all 0.3s;
        }
        .wallet-btn.connected { 
            background: linear-gradient(135deg, #00d26a 0%, #00a854 100%); 
        }
        .wallet-address { 
            font-size: 10px; 
            color: #666; 
            font-weight: 600;
            max-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .wallet-hint {
            position: absolute;
            top: 60px;
            right: 16px;
            background: linear-gradient(135deg, #fef3c7 0%, #fffbeb 100%);
            border: 1px solid #f59e0b;
            border-radius: 12px;
            padding: 10px 14px;
            font-size: 12px;
            color: #92400e;
            max-width: 200px;
            box-shadow: 0 4px 12px rgba(245,158,11,0.2);
            animation: pulse 2s infinite;
            z-index: 99;
        }
        .wallet-hint::before {
            content: 'ğŸ’¡';
            margin-right: 6px;
        }
        @keyframes pulse {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }
        .wallet-hint.hidden { display: none; }
        
        .back-btn { width: 36px; height: 36px; border-radius: 50%; background: rgba(0,0,0,0.05); border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; color: #1a1a1a; }
        
        .container { max-width: 480px; margin: 0 auto; padding: 0 16px; }
        
        .refresh-section {
            display: flex;
            justify-content: flex-end;
            margin: 8px 0;
        }
        .refresh-btn {
            background: white;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.2s;
        }
        .refresh-btn:hover {
            background: #f5f5f5;
            transform: translateY(-1px);
        }
        .refresh-btn:active {
            transform: scale(0.98);
        }
        .refresh-btn.spinning .refresh-icon {
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin: 12px 0; }
        .stat-card { background: white; border-radius: 16px; padding: 16px 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.05); text-align: center; }
        .stat-label { font-size: 11px; color: #999; margin-bottom: 4px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.3px; }
        .stat-value { font-size: 16px; font-weight: 700; color: #1a1a1a; letter-spacing: -0.5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .stat-sub { font-size: 10px; color: #00a854; margin-top: 2px; font-weight: 600; }
        .stat-sub.ai { color: #8b5cf6; }
        
        .price-pool-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 0 0 16px; }
        
        .price-module-full { 
            background: white; 
            border-radius: 20px; 
            padding: 20px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.05); 
            border: 1px solid rgba(0,0,0,0.05); 
            display: flex; 
            flex-direction: column;
            justify-content: center;
            position: relative;
        }
        .price-header-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .price-title-text { font-size: 11px; color: #666; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .price-change-full { font-size: 11px; font-weight: 700; color: #00a854; background: rgba(0,168,84,0.1); padding: 3px 6px; border-radius: 10px; }
        .price-change-full.down { color: #dc2626; background: rgba(220,38,38,0.1); }
        .price-value-full { font-size: 20px; font-weight: 800; color: #1a1a1a; letter-spacing: -0.5px; }
        .price-loading { font-size: 12px; color: #999; }
        .price-update-time { font-size: 9px; color: #999; margin-top: 4px; }
        .price-error { font-size: 11px; color: #dc2626; margin-top: 4px; }
        .price-source { font-size: 8px; color: #999; position: absolute; bottom: 4px; right: 8px; }
        
        .dividend-pool-module { 
            background: linear-gradient(135deg, #fef3c7 0%, #fffbeb 100%); 
            border-radius: 20px; 
            padding: 20px; 
            box-shadow: 0 4px 20px rgba(245,158,11,0.1); 
            border: 1px solid rgba(245,158,11,0.2); 
            display: flex; 
            flex-direction: column;
            justify-content: center;
            text-align: center;
        }
        .dividend-pool-label { 
            font-size: 11px; 
            color: #92400e; 
            margin-bottom: 6px; 
            font-weight: 600; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
        }
        .dividend-pool-value { 
            font-size: 22px; 
            font-weight: 800; 
            color: #b45309; 
            letter-spacing: -0.5px; 
            margin-bottom: 2px;
        }
        .dividend-pool-sub { 
            font-size: 10px; 
            color: #d97706; 
            font-weight: 600; 
        }
        
        .input-card { background: white; border-radius: 24px; padding: 28px 20px; margin: 0 0 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); text-align: center; }
        .input-label { font-size: 13px; color: #999; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
        .big-input { width: 100%; border: none; font-size: 42px; font-weight: 700; text-align: center; color: #1a1a1a; outline: none; margin-bottom: 16px; font-family: inherit; }
        .big-input::placeholder { color: #ddd; }
        
        .quick-buttons { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; }
        .quick-btn { background: #f5f5f5; border: 2px solid transparent; color: #1a1a1a; padding: 10px 16px; border-radius: 14px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; user-select: none; }
        .quick-btn:active { transform: scale(0.95); background: #e5e5e5; }
        .quick-btn.active-long { background: #1a1a1a; color: white; border-color: #1a1a1a; }
        
        .action-btn { width: 100%; background: #1a1a1a; color: white; border: none; padding: 16px; border-radius: 16px; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(0,0,0,0.15); }
        .action-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .action-btn:active:not(:disabled) { transform: scale(0.98); }
        .action-btn.burn { background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); }
        .action-btn.claim { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 16px; }
        .info-card { background: #fafafa; border-radius: 14px; padding: 14px; text-align: center; }
        .info-label { font-size: 11px; color: #999; margin-bottom: 4px; font-weight: 500; }
        .info-value { font-size: 16px; font-weight: 700; color: #1a1a1a; }
        
        .claim-container { padding: 16px; }
        .claim-header { background: linear-gradient(135deg, #fffbeb 0%, #ffffff 100%); border: 1px solid rgba(245,158,11,0.2); border-radius: 20px; padding: 24px; text-align: center; margin-bottom: 16px; box-shadow: 0 4px 20px rgba(245,158,11,0.1); }
        .claim-label { font-size: 12px; color: #92400e; margin-bottom: 8px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
        .claim-amount { font-size: 36px; font-weight: 800; color: #b45309; margin-bottom: 4px; letter-spacing: -1px; }
        .claim-unit { font-size: 14px; color: #d97706; font-weight: 600; margin-bottom: 20px; }
        .claim-btn { width: 100%; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; padding: 14px; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 15px rgba(245,158,11,0.3); }
        .claim-btn:disabled { opacity: 0.5; background: #ccc; box-shadow: none; cursor: not-allowed; }
        
        .claim-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 16px; }
        .claim-stat-item { background: white; border-radius: 12px; padding: 12px 8px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .claim-stat-label { font-size: 10px; color: #999; margin-bottom: 4px; }
        .claim-stat-value { font-size: 13px; font-weight: 700; color: #1a1a1a; }
        
        .claim-rule { background: white; border-radius: 16px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); font-size: 12px; color: #666; line-height: 1.6; text-align: center; }
        .claim-rule-title { font-weight: 700; color: #1a1a1a; margin-bottom: 6px; font-size: 13px; }
        
        .rank-header { padding: 60px 20px 20px; text-align: center; background: linear-gradient(180deg, #fafafa 0%, #ffffff 100%); }
        .rank-title { font-size: 28px; font-weight: 800; margin-bottom: 4px; }
        .rank-subtitle { font-size: 14px; color: #666; }
        
        .rank-tabs { display: flex; padding: 0 20px; margin-bottom: 16px; gap: 10px; }
        .rank-tab { flex: 1; padding: 12px; border-radius: 12px; border: none; background: #f5f5f5; font-size: 14px; font-weight: 600; color: #666; cursor: pointer; }
        .rank-tab.active { background: #1a1a1a; color: white; }
        
        .rank-list { padding: 0 16px; min-height: 300px; }
        .rank-item { display: flex; align-items: center; padding: 12px 16px; background: white; border-radius: 16px; margin-bottom: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .rank-number { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; margin-right: 12px; background: #f5f5f5; color: #666; }
        .rank-number.top1 { background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); color: #8b6914; }
        .rank-number.top2 { background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%); color: #666; }
        .rank-number.top3 { background: linear-gradient(135deg, #cd7f32 0%, #daa520 100%); color: white; }
        
        .rank-info { flex: 1; }
        .rank-address { font-size: 14px; font-weight: 600; color: #1a1a1a; margin-bottom: 2px; }
        .rank-amount { font-size: 12px; color: #666; }
        .rank-reward { font-size: 14px; font-weight: 700; color: #00a854; }
        
        .rank-loading { text-align: center; padding: 40px; color: #999; }
        .rank-empty { text-align: center; padding: 40px; color: #999; }
        
        .my-rank { position: fixed; bottom: 90px; left: 16px; right: 16px; background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); color: white; padding: 16px 20px; border-radius: 16px; display: flex; align-items: center; box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
        .my-rank-label { font-size: 12px; opacity: 0.8; margin-bottom: 2px; }
        .my-rank-value { font-size: 16px; font-weight: 700; }
        
        .bottom-nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(255,255,255,0.98); backdrop-filter: blur(20px); border-radius: 30px; padding: 10px 14px; display: flex; gap: 6px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); border: 1px solid rgba(0,0,0,0.05); z-index: 1000; max-width: 95%; }
        @media (min-width: 768px) { .bottom-nav { position: absolute; } }
        
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 3px; padding: 8px 14px; border-radius: 18px; cursor: pointer; transition: all 0.3s; min-width: 56px; color: #999; font-size: 10px; font-weight: 600; border: none; background: transparent; }
        .nav-item.active { background: #1a1a1a; color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .nav-icon { font-size: 18px; line-height: 1; }
        
        .tx-toast { position: fixed; top: 100px; left: 50%; transform: translateX(-50%); background: rgba(26,26,26,0.95); color: white; padding: 14px 24px; border-radius: 14px; font-size: 14px; font-weight: 500; z-index: 10000; display: none; backdrop-filter: blur(10px); box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-width: 90%; text-align: center; }
        .tx-toast.show { display: block; }
        .tx-toast.error { background: rgba(220,38,38,0.95); }
        
        .loading { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s ease-in-out infinite; }
        
        .public-action { background: white; border-radius: 20px; padding: 20px; margin: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .public-action-text { font-size: 13px; color: #666; flex: 1; }
        .public-action-text strong { color: #1a1a1a; display: block; margin-bottom: 4px; }
        .public-action-btn { background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 12px; font-size: 13px; font-weight: 700; cursor: pointer; white-space: nowrap; }
        .public-action-btn:disabled { opacity: 0.5; background: #ccc; }
    </style>
</head>
<body>
    <div class="mobile-container">
        <div id="txToast" class="tx-toast"></div>

        <!-- é¦–é¡µ -->
        <div id="homePage">
            <div class="top-nav">
                <div class="brand">è¸é©¬å°ç¥</div>
                <div class="wallet-area">
                    <button class="wallet-btn" id="walletBtn" onclick="connectWallet()">ğŸ’¼</button>
                    <div class="wallet-address" id="walletAddress" style="display: none;"></div>
                </div>
            </div>
            
            <div class="wallet-hint" id="walletHint">
                ä¸€åˆ‡çš„å¼€å§‹éƒ½è¦ä»è¿æ¥é’±åŒ…ã€æˆæƒé’±åŒ…å¼€å§‹
            </div>

            <div class="container">
                <div class="refresh-section">
                    <button class="refresh-btn" id="refreshBtn" onclick="refreshData()">
                        <span class="refresh-icon">ğŸ”„</span>
                        <span>åˆ·æ–°æ•°æ®</span>
                    </button>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">æˆ‘çš„ä½™é¢</div>
                        <div class="stat-value" id="balance">0.00</div>
                        <div class="stat-sub" id="tokenSymbolDisplay">TMFS</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">æˆ‘çš„ä»½é¢</div>
                        <div class="stat-value" id="myShares">0.00</div>
                        <div class="stat-sub">åˆ†çº¢æƒé‡</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">æ€»é”€æ¯é‡</div>
                        <div class="stat-value" id="totalBurnedDisplay">0</div>
                        <div class="stat-sub" id="totalSharesDisplay">æ€»ä»½é¢</div>
                    </div>
                </div>

                <div class="price-pool-grid">
                    <div class="price-module-full">
                        <div class="price-header-row">
                            <div class="price-title-text">ä»Šæ—¥å¸ä»·</div>
                            <div class="price-change-full" id="priceChange">--</div>
                        </div>
                        <div class="price-value-full" id="tokenPrice">
                            <span class="price-loading">åŠ è½½ä¸­...</span>
                        </div>
                        <div class="price-update-time" id="priceUpdateTime"></div>
                        <div class="price-error" id="priceError"></div>
                        <div class="price-source" id="priceSource"></div>
                    </div>
                    
                    <div class="dividend-pool-module">
                        <div class="dividend-pool-label">ğŸ’° åˆ†çº¢å¥–æ± </div>
                        <div class="dividend-pool-value" id="dividendPoolAmount">0.0000</div>
                        <div class="dividend-pool-sub">WBNB å¾…åˆ†é…</div>
                    </div>
                </div>

                <div class="public-action">
                    <div class="public-action-text">
                        <strong>ğŸ”„ è§¦å‘ç¨æ”¶å…‘æ¢</strong>
                        ä»»ä½•äººéƒ½å¯ä»¥è°ƒç”¨ï¼Œå°†åˆçº¦ä¸­çš„ä»£å¸å…‘æ¢ä¸º BNB å¹¶åˆ†é…åˆ°å¥–æ± 
                    </div>
                    <button class="public-action-btn" id="processBtn" onclick="processTax()">ç«‹å³è§¦å‘</button>
                </div>
            </div>
        </div>

        <!-- ç‡ƒçƒ§é¡µé¢ -->
        <div id="burnPage">
            <div class="top-nav">
                <button class="back-btn" onclick="showPage('home')">â†</button>
                <div class="brand" style="font-size: 16px;">ç‡ƒçƒ§ä»£å¸</div>
                <div style="width: 40px;"></div>
            </div>

            <div class="container" style="padding-top: 20px;">
                <div class="input-card">
                    <div class="input-label">ç‡ƒçƒ§æ•°é‡ (TMFS)</div>
                    <input type="number" class="big-input" id="burnAmountInput" placeholder="0" value="0">
                    
                    <div class="quick-buttons">
                        <button class="quick-btn" ontouchstart="startLongPress(this, 1000)" ontouchend="endLongPress()" onmousedown="startLongPress(this, 1000)" onmouseup="endLongPress()" onmouseleave="endLongPress()">+1k</button>
                        <button class="quick-btn" ontouchstart="startLongPress(this, 10000)" ontouchend="endLongPress()" onmousedown="startLongPress(this, 10000)" onmouseup="endLongPress()" onmouseleave="endLongPress()">+1w</button>
                        <button class="quick-btn" ontouchstart="startLongPress(this, 100000)" ontouchend="endLongPress()" onmousedown="startLongPress(this, 100000)" onmouseup="endLongPress()" onmouseleave="endLongPress()">+10w</button>
                        <button class="quick-btn" onclick="setMaxBurn()" style="background: #1a1a1a; color: white;">æœ€å¤§</button>
                    </div>
                    
                    <button class="action-btn burn" onclick="burnTokens()" id="burnBtn">ç¡®è®¤é”€æ¯</button>
                </div>

                <div class="info-grid">
                    <div class="info-card">
                        <div class="info-label">æˆ‘çš„ç´¯è®¡ç‡ƒçƒ§</div>
                        <div class="info-value" id="myTotalBurned">0</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">å…¨çƒç‡ƒçƒ§æ€»é‡</div>
                        <div class="info-value" id="globalBurned">0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- é¢†å–åˆ†çº¢é¡µé¢ -->
        <div id="claimPage">
            <div class="top-nav">
                <button class="back-btn" onclick="showPage('home')">â†</button>
                <div class="brand" style="font-size: 16px;">é¢†å–åˆ†çº¢</div>
                <div style="width: 40px;"></div>
            </div>

            <div class="claim-container">
                <div class="claim-header">
                    <div class="claim-label">å¯é¢†å– WBNB</div>
                    <div class="claim-amount" id="pendingWBNB">0.0000</div>
                    <div class="claim-unit">WBNB</div>
                    <button class="claim-btn" id="claimBtn" onclick="claimDividend()" disabled>é¢†å–åˆ†çº¢</button>
                </div>

                <div class="claim-stats">
                    <div class="claim-stat-item">
                        <div class="claim-stat-label">æˆ‘çš„ä»½é¢</div>
                        <div class="claim-stat-value" id="claimMyShares">0</div>
                    </div>
                    <div class="claim-stat-item">
                        <div class="claim-stat-label">å…¨çƒä»½é¢</div>
                        <div class="claim-stat-value" id="claimGlobalShares">0</div>
                    </div>
                    <div class="claim-stat-item">
                        <div class="claim-stat-label">æˆ‘çš„å æ¯”</div>
                        <div class="claim-stat-value" id="claimMyPercent">0%</div>
                    </div>
                    <div class="claim-stat-item">
                        <div class="claim-stat-label">ç´¯è®¡é¢†å–</div>
                        <div class="claim-stat-value" id="totalClaimedWBNB">0</div>
                    </div>
                </div>

                <div class="claim-rule">
                    <div class="claim-rule-title">ğŸ’¡ åˆ†çº¢è§„åˆ™</div>
                    é”€æ¯ TMFS è·å¾—åˆ†çº¢ä»½é¢ï¼ŒæŒ‰ä»½é¢å æ¯”åˆ†é… WBNB å¥–æ± ï¼Œå¯éšæ—¶é¢†å–ï¼Œæ— é”ä»“
                </div>
            </div>
        </div>

        <!-- æ’è¡Œé¡µé¢ -->
        <div id="rankPage">
            <div class="rank-header">
                <div class="rank-title">ğŸ† ç‡ƒçƒ§æ’è¡Œ</div>
                <div class="rank-subtitle">å…¨çƒ TMFS ç‡ƒçƒ§é‡æ’è¡Œæ¦œ</div>
            </div>

            <div class="rank-tabs">
                <button class="rank-tab active" onclick="switchRankTab('burn')" data-tab="burn">ç‡ƒçƒ§æ’è¡Œ</button>
                <button class="rank-tab" onclick="switchRankTab('reward')" data-tab="reward">æ”¶ç›Šæ’è¡Œ</button>
            </div>

            <div class="rank-list" id="rankList">
                <div class="rank-loading">åŠ è½½ä¸­...</div>
            </div>

            <div class="my-rank">
                <div style="flex: 1;">
                    <div class="my-rank-label">æˆ‘çš„æ’å / ç‡ƒçƒ§é‡</div>
                    <div class="my-rank-value" id="myRank">æœªä¸Šæ¦œ</div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 12px; opacity: 0.8;">å¾…é¢†å–</div>
                    <div style="font-size: 16px; font-weight: 700;" id="myRankReward">0 WBNB</div>
                </div>
            </div>
        </div>

        <!-- åº•éƒ¨å¯¼èˆª -->
        <div class="bottom-nav">
            <button class="nav-item active" onclick="showPage('home')" data-page="home">
                <span class="nav-icon">ğŸ </span>
                <span>é¦–é¡µ</span>
            </button>
            <button class="nav-item" onclick="showPage('burn')" data-page="burn">
                <span class="nav-icon">ğŸ”¥</span>
                <span>ç‡ƒçƒ§</span>
            </button>
            <button class="nav-item" onclick="showPage('claim')" data-page="claim">
                <span class="nav-icon">ğŸ’</span>
                <span>é¢†åˆ†çº¢</span>
            </button>
            <button class="nav-item" onclick="showPage('rank')" data-page="rank">
                <span class="nav-icon">ğŸ†</span>
                <span>æ’è¡Œ</span>
            </button>
        </div>
    </div>

    <script>
        // ==================== é…ç½®åŠ è½½ ====================
        if (!window.CONTRACT_CONFIG) {
            alert('é”™è¯¯ï¼šæœªæ‰¾åˆ° abi.js æ–‡ä»¶ï¼');
            throw new Error('CONTRACT_CONFIG not found');
        }

        const CONFIG = window.CONTRACT_CONFIG;
        
        // BurnPool åˆçº¦é…ç½®ï¼ˆä½¿ç”¨ä½ éƒ¨ç½²çš„åœ°å€ï¼‰
        const BURN_POOL_ABI = CONFIG.dividendABI || [
            "function burn(uint256 amount) external",
            "function claim() external",
            "function processAndDistribute() external",
            "function pendingDividends(address user) view returns (uint256)",
            "function shares(address) view returns (uint256)",
            "function totalShares() view returns (uint256)",
            "function totalBurned() view returns (uint256)",
            "function totalDividendsDistributed() view returns (uint256)",
            "function dividendsPerShare() view returns (uint256)",
            "function payouts(address) view returns (int256)",
            "event Burn(address indexed user, uint256 amount, uint256 totalShares)",
            "event Claim(address indexed user, uint256 bnbAmount)",
            "event TaxProcessed(uint256 marketingBNB, uint256 dividendBNB, uint256 totalBNBReceived)"
        ];
        
        const TOKEN_ABI = CONFIG.tokenABI || [
            "function balanceOf(address account) view returns (uint256)",
            "function decimals() view returns (uint8)",
            "function approve(address spender, uint256 amount) returns (bool)",
            "function allowance(address owner, address spender) view returns (uint256)",
            "function transferFrom(address sender, address recipient, uint256 amount) returns (bool)",
            "function symbol() view returns (string)"
        ];

        const BURN_POOL_ADDRESS = CONFIG.dividendAddress; // BurnPool åˆçº¦åœ°å€
        const TOKEN_ADDRESS = CONFIG.tokenAddress; // ä½ çš„ä»£å¸åœ°å€
        const TOKEN_DECIMALS = CONFIG.decimals || 18;
        const TOKEN_SYMBOL = CONFIG.symbol || "TMFS";
        
        const WBNB_ADDRESS = "0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c";
        const APPROVE_AMOUNT = ethers.parseUnits("100000000", TOKEN_DECIMALS); // æˆæƒ1äº¿ä¸ª

        // ==================== å…¨å±€å˜é‡ ====================
        let provider = null;
        let signer = null;
        let burnPoolContract = null;
        let tokenContract = null;
        let wbnbContract = null;
        let userAddress = null;
        let longPressTimer = null;
        let longPressInterval = null;
        const LONG_PRESS_DELAY = 500;

        // ==================== å·¥å…·å‡½æ•° ====================
        function showToast(message, isError = false) {
            const toast = document.getElementById('txToast');
            toast.textContent = message;
            toast.className = 'tx-toast ' + (isError ? 'error' : '') + ' show';
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function formatAddress(address) {
            if (!address) return '--';
            return address.slice(0, 6) + '...' + address.slice(-4);
        }

        function formatAmount(amount, decimals = 2) {
            if (!amount || amount === '0' || amount == 0) return '0.00';
            const num = parseFloat(amount);
            if (num > 1000000) return (num / 1000000).toFixed(decimals) + 'M';
            if (num > 1000) return (num / 1000).toFixed(decimals) + 'K';
            return num.toFixed(decimals);
        }

        // ==================== å¸ä»·è·å– ====================
        async function fetchTokenPrice(forceRefresh = false) {
            const priceEl = document.getElementById('tokenPrice');
            const changeEl = document.getElementById('priceChange');
            const timeEl = document.getElementById('priceUpdateTime');
            const errorEl = document.getElementById('priceError');
            const sourceEl = document.getElementById('priceSource');
            
            errorEl.textContent = '';
            sourceEl.textContent = '';
            
            // æ–¹æ³•1: DexScreener
            try {
                const response = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${TOKEN_ADDRESS}?_=${Date.now()}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.pairs && data.pairs.length > 0) {
                        const pair = data.pairs.sort((a, b) => parseFloat(b.volume?.h24 || 0) - parseFloat(a.volume?.h24 || 0))[0];
                        const price = parseFloat(pair.priceUsd);
                        const change = parseFloat(pair.priceChange?.h24 || 0);
                        
                        if (price > 0) {
                            priceEl.textContent = '$' + (price < 0.01 ? price.toFixed(8) : price.toFixed(6));
                            changeEl.textContent = (change >= 0 ? '+' : '') + change.toFixed(2) + '%';
                            changeEl.className = 'price-change-full ' + (change < 0 ? 'down' : '');
                            timeEl.textContent = 'å®æ—¶';
                            sourceEl.textContent = 'DexScreener';
                            return;
                        }
                    }
                }
            } catch (e) {}
            
            // æ–¹æ³•2: CoinGecko
            try {
                const response = await fetch(`https://api.coingecko.com/api/v3/simple/token_price/binance-smart-chain?contract_addresses=${TOKEN_ADDRESS.toLowerCase()}&vs_currencies=usd&include_24hr_change=true`);
                if (response.ok) {
                    const data = await response.json();
                    const tokenData = data[TOKEN_ADDRESS.toLowerCase()];
                    if (tokenData && tokenData.usd > 0) {
                        priceEl.textContent = '$' + tokenData.usd.toFixed(8);
                        const change = tokenData.usd_24h_change || 0;
                        changeEl.textContent = (change >= 0 ? '+' : '') + change.toFixed(2) + '%';
                        changeEl.className = 'price-change-full ' + (change < 0 ? 'down' : '');
                        timeEl.textContent = 'å®æ—¶';
                        sourceEl.textContent = 'CoinGecko';
                        return;
                    }
                }
            } catch (e) {}
            
            priceEl.innerHTML = '<span style="font-size: 14px;">æš‚æœªæ”¶å½•</span>';
            errorEl.textContent = 'æ–°ä»£å¸éœ€ç­‰å¾… 24-48 å°æ—¶';
        }

        // ==================== é•¿æŒ‰åŠŸèƒ½ ====================
        function startLongPress(btn, amount) {
            btn.classList.add('active-long');
            addToBurnInput(amount);
            
            longPressTimer = setTimeout(() => {
                longPressInterval = setInterval(() => {
                    addToBurnInput(amount);
                }, 100);
            }, LONG_PRESS_DELAY);
        }

        function endLongPress() {
            if (longPressTimer) { clearTimeout(longPressTimer); longPressTimer = null; }
            if (longPressInterval) { clearInterval(longPressInterval); longPressInterval = null; }
            document.querySelectorAll('.quick-btn').forEach(btn => btn.classList.remove('active-long'));
        }

        function addToBurnInput(amount) {
            const input = document.getElementById('burnAmountInput');
            const current = parseFloat(input.value) || 0;
            input.value = current + amount;
        }

        function setMaxBurn() {
            if (!tokenContract || !userAddress) return;
            tokenContract.balanceOf(userAddress).then(balance => {
                document.getElementById('burnAmountInput').value = ethers.formatUnits(balance, TOKEN_DECIMALS);
            });
        }

        // ==================== é’±åŒ…è¿æ¥ ====================
        async function connectWallet() {
            if (!window.ethereum) { 
                alert('è¯·å®‰è£… MetaMaskï¼'); 
                return; 
            }
            
            const btn = document.getElementById('walletBtn');
            btn.innerHTML = '<span class="loading"></span>';
            
            try {
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                // åˆ‡æ¢ BSC
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: '0x38' }]
                    });
                } catch (switchError) {
                    if (switchError.code === 4902) {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: '0x38',
                                chainName: 'BNB Smart Chain',
                                nativeCurrency: { name: 'BNB', symbol: 'BNB', decimals: 18 },
                                rpcUrls: ['https://bsc-dataseed.binance.org/'],
                                blockExplorerUrls: ['https://bscscan.com']
                            }]
                        });
                    }
                }
                
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                userAddress = await signer.getAddress();
                
                // åˆå§‹åŒ–åˆçº¦
                burnPoolContract = new ethers.Contract(BURN_POOL_ADDRESS, BURN_POOL_ABI, signer);
                tokenContract = new ethers.Contract(TOKEN_ADDRESS, TOKEN_ABI, signer);
                wbnbContract = new ethers.Contract(WBNB_ADDRESS, ["function balanceOf(address) view returns (uint256)"], signer);
                
                btn.classList.add('connected');
                btn.innerHTML = 'âœ“';
                
                document.getElementById('walletAddress').textContent = formatAddress(userAddress);
                document.getElementById('walletAddress').style.display = 'block';
                document.getElementById('walletHint').classList.add('hidden');
                
                await loadAllData();
                showToast(`å·²è¿æ¥: ${formatAddress(userAddress)}`);
                
            } catch (error) {
                console.error(error);
                btn.innerHTML = 'ğŸ’¼';
                showToast('è¿æ¥å¤±è´¥', true);
            }
        }

        // ==================== æ•°æ®åŠ è½½ ====================
        async function loadAllData() {
            if (!userAddress || !burnPoolContract) return;
            
            try {
                // æˆ‘çš„ä½™é¢
                const balance = await tokenContract.balanceOf(userAddress);
                document.getElementById('balance').textContent = formatAmount(ethers.formatUnits(balance, TOKEN_DECIMALS));
                
                // åˆ†çº¢æ±  WBNB ä½™é¢ï¼ˆå…³é”®ï¼šç”¨ WBNB åˆçº¦æŸ¥ï¼Œä¸æ˜¯ provider.getBalanceï¼‰
                const poolWBNB = await wbnbContract.balanceOf(BURN_POOL_ADDRESS);
                document.getElementById('dividendPoolAmount').textContent = parseFloat(ethers.formatEther(poolWBNB)).toFixed(4);
                
                // æˆ‘çš„ä»½é¢
                const shares = await burnPoolContract.shares(userAddress);
                const totalShares = await burnPoolContract.totalShares();
                document.getElementById('myShares').textContent = formatAmount(ethers.formatUnits(shares, TOKEN_DECIMALS));
                document.getElementById('claimMyShares').textContent = formatAmount(ethers.formatUnits(shares, TOKEN_DECIMALS));
                document.getElementById('claimGlobalShares').textContent = formatAmount(ethers.formatUnits(totalShares, TOKEN_DECIMALS));
                
                // å æ¯”
                if (totalShares > 0) {
                    const percent = (Number(shares) * 100 / Number(totalShares)).toFixed(2);
                    document.getElementById('claimMyPercent').textContent = percent + '%';
                }
                
                // æ€»é”€æ¯é‡
                const totalBurned = await burnPoolContract.totalShares(); // è¿™é‡Œ shares = burned
                document.getElementById('totalBurnedDisplay').textContent = formatAmount(ethers.formatUnits(totalBurned, TOKEN_DECIMALS));
                document.getElementById('totalSharesDisplay').textContent = 'æ€»ä»½é¢';
                document.getElementById('globalBurned').textContent = formatAmount(ethers.formatUnits(totalBurned, TOKEN_DECIMALS));
                document.getElementById('claimGlobalShares').textContent = formatAmount(ethers.formatUnits(totalBurned, TOKEN_DECIMALS));
                
                // æˆ‘çš„ç´¯è®¡ç‡ƒçƒ§ï¼ˆå°±æ˜¯ sharesï¼‰
                document.getElementById('myTotalBurned').textContent = formatAmount(ethers.formatUnits(shares, TOKEN_DECIMALS));
                
                // å¾…é¢†å–åˆ†çº¢
                const pending = await burnPoolContract.pendingDividends(userAddress);
                const pendingBNB = ethers.formatEther(pending);
                document.getElementById('pendingWBNB').textContent = parseFloat(pendingBNB).toFixed(4);
                document.getElementById('claimBtn').disabled = parseFloat(pendingBNB) <= 0;
                document.getElementById('myRankReward').textContent = parseFloat(pendingBNB).toFixed(4) + ' WBNB';
                
                // ç´¯è®¡å·²é¢†å–ï¼ˆé€šè¿‡ payouts è®¡ç®—ï¼‰
                const payouts = await burnPoolContract.payouts(userAddress);
                const dividendsPerShare = await burnPoolContract.dividendsPerShare();
                const entitled = (shares * dividendsPerShare) / BigInt(1e18);
                const claimed = entitled - pending;
                document.getElementById('totalClaimedWBNB').textContent = formatAmount(ethers.formatEther(claimed), 4);
                
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
            }
        }

        async function refreshData() {
            const btn = document.getElementById('refreshBtn');
            btn.classList.add('spinning');
            showToast('æ­£åœ¨åˆ·æ–°...');
            
            try {
                await fetchTokenPrice(true);
                if (userAddress) await loadAllData();
                showToast('åˆ·æ–°æˆåŠŸ');
            } catch (error) {
                showToast('åˆ·æ–°å¤±è´¥', true);
            } finally {
                setTimeout(() => btn.classList.remove('spinning'), 500);
            }
        }

        // ==================== ç‡ƒçƒ§åŠŸèƒ½ ====================
        async function burnTokens() {
            if (!burnPoolContract) { showToast('è¯·å…ˆè¿æ¥é’±åŒ…', true); return; }
            
            const amount = document.getElementById('burnAmountInput').value;
            if (!amount || amount <= 0) { showToast('è¯·è¾“å…¥æ•°é‡', true); return; }
            
            const btn = document.getElementById('burnBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> å¤„ç†ä¸­...';
            
            try {
                const amountWei = ethers.parseUnits(amount.toString(), TOKEN_DECIMALS);
                
                // æ£€æŸ¥æˆæƒ
                const allowance = await tokenContract.allowance(userAddress, BURN_POOL_ADDRESS);
                if (allowance < amountWei) {
                    showToast('æ­£åœ¨æˆæƒ...');
                    const approveTx = await tokenContract.approve(BURN_POOL_ADDRESS, APPROVE_AMOUNT);
                    await approveTx.wait();
                }
                
                // æ‰§è¡Œ burn
                showToast('æ­£åœ¨é”€æ¯...');
                const tx = await burnPoolContract.burn(amountWei);
                await tx.wait();
                
                showToast(`æˆåŠŸé”€æ¯ ${amount} ${TOKEN_SYMBOL}`);
                document.getElementById('burnAmountInput').value = '0';
                await loadAllData();
                
            } catch (error) {
                console.error(error);
                showToast(error.reason || 'é”€æ¯å¤±è´¥', true);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'ç¡®è®¤é”€æ¯';
            }
        }

        // ==================== é¢†å–åˆ†çº¢ ====================
        async function claimDividend() {
            if (!burnPoolContract) { showToast('è¯·å…ˆè¿æ¥é’±åŒ…', true); return; }
            
            const btn = document.getElementById('claimBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span>';
            
            try {
                const tx = await burnPoolContract.claim();
                showToast('é¢†å–ä¸­...');
                await tx.wait();
                
                showToast('WBNB é¢†å–æˆåŠŸï¼');
                await loadAllData();
            } catch (error) {
                console.error(error);
                showToast(error.reason || 'é¢†å–å¤±è´¥', true);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'é¢†å–åˆ†çº¢';
            }
        }

        // ==================== è§¦å‘ç¨æ”¶å…‘æ¢ ====================
        async function processTax() {
            if (!burnPoolContract) { showToast('è¯·å…ˆè¿æ¥é’±åŒ…', true); return; }
            
            const btn = document.getElementById('processBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> å¤„ç†ä¸­';
            
            try {
                const tx = await burnPoolContract.processAndDistribute();
                showToast('å…‘æ¢ä¸­...');
                await tx.wait();
                
                showToast('ç¨æ”¶å…‘æ¢æˆåŠŸï¼BNB å·²åˆ†é…');
                await loadAllData();
            } catch (error) {
                console.error(error);
                showToast(error.reason || 'å…‘æ¢å¤±è´¥', true);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'ç«‹å³è§¦å‘';
            }
        }

        // ==================== æ’è¡Œ ====================
        function loadRankData() {
            const rankList = document.getElementById('rankList');
            
            // æ¨¡æ‹Ÿæ•°æ®ï¼ˆå®é™…é¡¹ç›®ä¸­åº”ä» The Graph æˆ–åç«¯è·å–ï¼‰
            const mockData = [
                { address: '0x1234...5678', amount: '1,245,000', reward: '0.45' },
                { address: '0xabcd...efgh', amount: '980,000', reward: '0.32' },
                { address: '0x1111...2222', amount: '756,000', reward: '0.28' },
                { address: '0x3333...4444', amount: '542,000', reward: '0.19' },
                { address: '0x5555...6666', amount: '328,000', reward: '0.12' },
            ];
            
            let html = '';
            mockData.forEach((item, index) => {
                const rankClass = index === 0 ? 'top1' : index === 1 ? 'top2' : index === 2 ? 'top3' : '';
                const rankNum = index + 1;
                html += `
                    <div class="rank-item">
                        <div class="rank-number ${rankClass}">${rankNum}</div>
                        <div class="rank-info">
                            <div class="rank-address">${item.address}</div>
                            <div class="rank-amount">${item.amount} TMFS</div>
                        </div>
                        <div class="rank-reward">${item.reward} WBNB</div>
                    </div>
                `;
            });
            
            rankList.innerHTML = html;
            
            // æ›´æ–°æˆ‘çš„æ’åï¼ˆå®é™…åº”ä»åˆçº¦äº‹ä»¶ç»Ÿè®¡ï¼‰
            if (userAddress) {
                document.getElementById('myRank').textContent = 'ç¬¬ 99+ å | ç‡ƒçƒ§ 0 TMFS';
            }
        }

        function switchRankTab(tab) {
            document.querySelectorAll('.rank-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            // è¿™é‡Œå¯ä»¥åˆ‡æ¢æ•°æ®æºï¼Œç›®å‰ç”¨åŒä¸€å¥— mock æ•°æ®æ¼”ç¤º
        }

        // ==================== é¡µé¢åˆ‡æ¢ ====================
        function showPage(page) {
            ['homePage', 'burnPage', 'claimPage', 'rankPage'].forEach(id => {
                document.getElementById(id).style.display = 'none';
            });
            
            const pageMap = { 'home': 'homePage', 'burn': 'burnPage', 'claim': 'claimPage', 'rank': 'rankPage' };
            document.getElementById(pageMap[page]).style.display = 'block';
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`.nav-item[data-page="${page}"]`)?.classList.add('active');
            
            if (page === 'rank') loadRankData();
            if (page !== 'rank' && userAddress) loadAllData();
        }

        // ==================== åˆå§‹åŒ– ====================
        window.addEventListener('load', () => {
            fetchTokenPrice();
            setInterval(() => fetchTokenPrice(), 30000); // 30ç§’åˆ·æ–°ä»·æ ¼
            
            if (window.ethereum) {
                window.ethereum.on('accountsChanged', () => location.reload());
                window.ethereum.on('chainChanged', () => location.reload());
            }
        });
    </script>
</body>
</html>
