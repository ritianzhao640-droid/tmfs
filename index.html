<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>è¸é©¬å°ç¥ - ç‡ƒçƒ§åˆ†çº¢</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:#0b0f17;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto}
    .container{max-width:420px;margin:0 auto;padding:25px}
    
    .wallet-bar{background:linear-gradient(135deg,#1e293b 0%,#0f172a 100%);border:1px solid #334155;border-radius:12px;padding:12px 16px;margin-bottom:20px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px}
    .wallet-status{display:flex;align-items:center;gap:8px;font-size:14px}
    .status-dot{width:8px;height:8px;border-radius:50%;background:#ef4444;transition:all 0.3s}
    .status-dot.connected{background:#10b981;box-shadow:0 0 8px #10b981}
    .wallet-btn{background:#3b82f6;color:#fff;border:none;padding:8px 16px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer}
    .wallet-btn.disconnect{background:#475569}
    
    .card{background:#121a29;border-radius:16px;padding:24px;margin-bottom:16px}
    .title{font-size:22px;font-weight:700;color:#ffdf4f;margin-bottom:6px}
    .subtitle{color:#9ca3af;font-size:14px;margin-bottom:20px}
    
    .panel{display:flex;justify-content:space-between;background:#111827;padding:14px 16px;border-radius:12px;margin-bottom:10px;align-items:center}
    .panel-info{display:flex;flex-direction:column}
    .label{color:#9ca3af;font-size:13px;margin-bottom:2px}
    .value{color:#fff;font-weight:600;font-size:16px}
    .sub-value{color:#64748b;font-size:12px;margin-top:2px}
    
    input{width:100%;background:#1e293b;border:none;border-radius:12px;padding:14px 16px;color:#fff;font-size:16px;margin-bottom:8px}
    button{width:100%;padding:16px;border:none;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;margin-bottom:8px;transition:all 0.2s}
    .btn-approve{background:#f59e0b;color:#fff}
    .btn-approve:hover{background:#d97706}
    .btn-approve:disabled{background:#92400e;cursor:not-allowed}
    .btn-burn{background:#ef4444;color:#fff}
    .btn-burn:hover{background:#dc2626}
    .btn-claim{background:#10b981;color:#fff;margin-top:8px}
    .btn-claim:hover{background:#059669}
    .btn-refresh{background:#3b82f6;color:#fff;margin-top:8px}
    .btn-refresh:hover{background:#2563eb}
    
    .btn-row{display:flex;gap:8px}
    .btn-row button{flex:1;margin-bottom:0}
    
    .success-box{background:rgba(16,185,129,0.1);border:1px solid #10b981;color:#6ee7b7;padding:12px;border-radius:8px;margin:12px 0;font-size:14px;display:none}
    .tip{font-size:12px;color:#94a3b8;margin-top:12px;padding:10px;background:#0f172a;border-radius:8px;border-left:3px solid #3b82f6}
    
    .loading{display:inline-block;width:16px;height:16px;border:2px solid #fff;border-top-color:transparent;border-radius:50%;animation:spin 0.8s linear infinite;margin-left:8px;vertical-align:middle}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
<div class="container">

  <div class="wallet-bar" id="walletBar">
    <div class="wallet-status">
      <div class="status-dot" id="statusDot"></div>
      <span id="statusText">æœªè¿æ¥é’±åŒ…</span>
    </div>
    <button class="wallet-btn" id="connectBtn" onclick="toggleConnect()">è¿æ¥é’±åŒ…</button>
  </div>

  <div class="card">
    <div class="title">ğŸ”¥ è¸é©¬å°ç¥ ç‡ƒçƒ§åˆ†çº¢</div>
    <div class="subtitle">Burn To Earn | ç‡ƒçƒ§è·å–åˆ†çº¢æƒ</div>

    <div class="panel">
      <div class="panel-info">
        <div class="label">ä»£å¸ä½™é¢</div>
      </div>
      <div class="panel-info" style="text-align:right">
        <div class="value" id="balance">--</div>
      </div>
    </div>
    
    <div class="panel">
      <div class="panel-info">
        <div class="label">æˆ‘å·²ç‡ƒçƒ§</div>
        <div class="sub-value" id="burnedSub">ç´¯è®¡ç‡ƒçƒ§æ•°é‡</div>
      </div>
      <div class="panel-info" style="text-align:right">
        <div class="value" id="myburn">--</div>
      </div>
    </div>
    
    <div class="panel">
      <div class="panel-info">
        <div class="label">å¯é¢†å–åˆ†çº¢</div>
        <div class="sub-value" id="claimSub">â‰ˆ $0.00</div>
      </div>
      <div class="panel-info" style="text-align:right">
        <div class="value" id="pending">--</div>
      </div>
    </div>

    <div style="margin:20px 0;">
      <input id="amount" type="number" placeholder="è¾“å…¥ç‡ƒçƒ§æ•°é‡" min="0" step="0.01"/>
    </div>

    <!-- æˆæƒæŒ‰é’®ï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼Œå·²æˆæƒåå˜ç°æç¤ºï¼‰ -->
    <button class="btn-approve" id="btnApprove" onclick="approve()">ğŸ”“ æˆæƒä»£å¸ï¼ˆé¦–æ¬¡ä½¿ç”¨ï¼‰</button>
    
    <button class="btn-burn" id="btnBurn" onclick="burn()">ğŸ”¥ ç«‹å³ç‡ƒçƒ§</button>
    <button class="btn-claim" id="btnClaim" onclick="claim()">ğŸ’° é¢†å–åˆ†çº¢</button>
    
    <!-- åˆ·æ–°æŒ‰é’® -->
    <div class="btn-row">
      <button class="btn-refresh" onclick="updateData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
    </div>
    
    <div class="success-box" id="successBox"></div>
    
    <div class="tip">
      ğŸ’¡ <strong>ä½¿ç”¨æ­¥éª¤ï¼š</strong><br>
      1. é¦–æ¬¡ä½¿ç”¨ç‚¹å‡»"æˆæƒä»£å¸"å¹¶ç¡®è®¤<br>
      2. è¾“å…¥æ•°é‡ç‚¹å‡»"ç«‹å³ç‡ƒçƒ§"<br>
      3. ç‡ƒçƒ§åç‚¹å‡»"ğŸ”„ åˆ·æ–°æ•°æ®"æŸ¥çœ‹æ›´æ–°<br>
      4. æœ‰åˆ†çº¢åç‚¹å‡»"é¢†å–åˆ†çº¢"æå– BNB
    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/web3@1.10.3/dist/web3.min.js"></script>
<script>
const CONTRACT = "0x9a889E525FAEF4851bf5BEbfb5F294AC9D097777";
const MAX_UINT = "115792089237316195423570985008687907853269984665640564039457584007913129639935";

const ABI = [
  // ERC20 æ ‡å‡†
  {"constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"constant":true,"inputs":[{"name":"_owner","type":"address"},{"name":"_spender","type":"address"}],"name":"allowance","outputs":[{"name":"remaining","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"name":"_spender","type":"address"},{"name":"_value","type":"uint256"}],"name":"approve","stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"name":"_to","type":"address"},{"name":"_value","type":"uint256"}],"name":"transfer","stateMutability":"nonpayable","type":"function"},
  // ç‡ƒçƒ§åˆ†çº¢åŠŸèƒ½
  {"inputs":[],"name":"claim","stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"name":"user","type":"address"}],"name":"claimable","outputs":[{"name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"name":"user","type":"address"}],"name":"burnAmount","outputs":[{"name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"totalBurned","outputs":[{"name":"","type":"uint256"}],"stateMutability":"view","type":"function"}
];

let web3, account, contract;

function showSuccess(msg) {
  const box = document.getElementById('successBox');
  box.textContent = msg;
  box.style.display = 'block';
  setTimeout(() => box.style.display = 'none', 5000);
}

async function toggleConnect() {
  if (account) {
    // æ–­å¼€è¿æ¥
    account = null;
    web3 = null;
    contract = null;
    document.getElementById('statusDot').classList.remove('connected');
    document.getElementById('statusText').textContent = 'æœªè¿æ¥é’±åŒ…';
    document.getElementById('connectBtn').textContent = 'è¿æ¥é’±åŒ…';
    document.getElementById('connectBtn').classList.remove('disconnect');
    return;
  }
  connect();
}

async function connect() {
  try {
    if (!window.ethereum) {
      alert('è¯·ä½¿ç”¨ TokenPocket æˆ– MetaMask é’±åŒ…æµè§ˆå™¨æ‰“å¼€');
      return;
    }
    
    web3 = new Web3(window.ethereum);
    const accounts = await window.ethereum.request({method: 'eth_requestAccounts'});
    account = accounts[0];
    
    contract = new web3.eth.Contract(ABI, CONTRACT);
    
    document.getElementById('statusDot').classList.add('connected');
    document.getElementById('statusText').textContent = account.slice(0,6) + '...' + account.slice(-4);
    document.getElementById('connectBtn').textContent = 'æ–­å¼€è¿æ¥';
    document.getElementById('connectBtn').classList.add('disconnect');
    
    // åŠ è½½æ•°æ®å¹¶æ£€æŸ¥æˆæƒ
    await updateData();
    await checkApprove();
    
    // ç›‘å¬è´¦æˆ·å˜åŒ–
    window.ethereum.on('accountsChanged', (accs) => {
      if (accs.length === 0) {
        location.reload();
      } else {
        account = accs[0];
        updateData();
        checkApprove();
      }
    });
    
  } catch (err) {
    alert('è¿æ¥å¤±è´¥: ' + err.message);
  }
}

// æ£€æŸ¥æˆæƒçŠ¶æ€
async function checkApprove() {
  if (!contract || !account) return;
  
  try {
    const allowance = await contract.methods.allowance(account, CONTRACT).call();
    const allowed = parseFloat(web3.utils.fromWei(allowance, 'ether'));
    
    const btn = document.getElementById('btnApprove');
    
    if (allowed > 1000000) {
      // å·²æˆæƒ
      btn.textContent = 'âœ… å·²æˆæƒï¼ˆæ— éœ€é‡å¤æ“ä½œï¼‰';
      btn.disabled = true;
      btn.style.opacity = '0.6';
    } else {
      // æœªæˆæƒ
      btn.textContent = 'ğŸ”“ æˆæƒä»£å¸ï¼ˆé¦–æ¬¡ä½¿ç”¨ï¼‰';
      btn.disabled = false;
      btn.style.opacity = '1';
    }
  } catch (err) {
    console.error('æ£€æŸ¥æˆæƒå¤±è´¥:', err);
  }
}

// æ›´æ–°æ‰€æœ‰æ•°æ®
async function updateData() {
  if (!contract || !account) {
    alert('è¯·å…ˆè¿æ¥é’±åŒ…');
    return;
  }
  
  const btn = document.querySelector('.btn-refresh');
  const originalText = btn.innerHTML;
  btn.innerHTML = '<span class="loading"></span> åˆ·æ–°ä¸­...';
  btn.disabled = true;
  
  try {
    // 1. æŸ¥è¯¢ä½™é¢
    const bal = await contract.methods.balanceOf(account).call();
    const balEth = parseFloat(web3.utils.fromWei(bal, 'ether')).toFixed(2);
    document.getElementById('balance').textContent = balEth + ' è¸é©¬å°ç¥';
    
    // 2. æŸ¥è¯¢å·²ç‡ƒçƒ§æ•°é‡
    const burned = await contract.methods.burnAmount(account).call();
    const burnedEth = web3.utils.fromWei(burned, 'ether');
    document.getElementById('myburn').textContent = burnedEth + ' è¸é©¬å°ç¥';
    document.getElementById('burnedSub').textContent = 'ç´¯è®¡å·²é”€æ¯ ' + burnedEth + ' ä¸ª';
    
    // 3. æŸ¥è¯¢å¯é¢†å–åˆ†çº¢
    const claimable = await contract.methods.claimable(account).call();
    const claimEth = parseFloat(web3.utils.fromWei(claimable, 'ether')).toFixed(4);
    document.getElementById('pending').textContent = claimEth + ' BNB';
    document.getElementById('claimSub').textContent = 'â‰ˆ $' + (claimEth * 300).toFixed(2) + ' USD';
    
    showSuccess('âœ… æ•°æ®å·²æ›´æ–°');
    
  } catch (err) {
    console.error('æ›´æ–°æ•°æ®å¤±è´¥:', err);
    alert('åˆ·æ–°å¤±è´¥: ' + err.message);
  } finally {
    btn.innerHTML = originalText;
    btn.disabled = false;
  }
}

async function approve() {
  if (!account) {
    alert('è¯·å…ˆè¿æ¥é’±åŒ…');
    return;
  }
  
  const btn = document.getElementById('btnApprove');
  btn.innerHTML = '<span class="loading"></span> æˆæƒä¸­...';
  btn.disabled = true;
  
  try {
    await contract.methods.approve(CONTRACT, MAX_UINT).send({
      from: account,
      gas: 100000
    });
    
    showSuccess('âœ… æˆæƒæˆåŠŸï¼ç°åœ¨å¯ä»¥ç‡ƒçƒ§ä»£å¸äº†');
    await checkApprove(); // æ›´æ–°æŒ‰é’®çŠ¶æ€
    
  } catch (err) {
    if (err.message.includes('rejected')) {
      alert('æ‚¨å–æ¶ˆäº†æˆæƒ');
    } else {
      alert('æˆæƒå¤±è´¥: ' + err.message);
    }
    btn.disabled = false;
  }
}

async function burn() {
  if (!account) {
    alert('è¯·å…ˆè¿æ¥é’±åŒ…');
    return;
  }
  
  const amount = document.getElementById('amount').value;
  if (!amount || amount <= 0) {
    alert('è¯·è¾“å…¥ç‡ƒçƒ§æ•°é‡');
    return;
  }
  
  // æ£€æŸ¥æ˜¯å¦å·²æˆæƒ
  const allowance = await contract.methods.allowance(account, CONTRACT).call();
  if (parseFloat(web3.utils.fromWei(allowance, 'ether')) < parseFloat(amount)) {
    alert('è¯·å…ˆç‚¹å‡»"æˆæƒä»£å¸"è¿›è¡Œæˆæƒ');
    return;
  }
  
  const btn = document.getElementById('btnBurn');
  btn.innerHTML = '<span class="loading"></span> ç‡ƒçƒ§ä¸­...';
  btn.disabled = true;
  
  try {
    const value = web3.utils.toWei(amount, 'ether');
    
    // ä½¿ç”¨è½¬è´¦åˆ°åˆçº¦åœ°å€çš„æ–¹å¼ç‡ƒçƒ§
    await contract.methods.transfer(CONTRACT, value).send({
      from: account,
      gas: 200000
    });
    
    showSuccess('âœ… ç‡ƒçƒ§æˆåŠŸï¼å·²é”€æ¯ ' + amount + ' è¸é©¬å°ç¥');
    document.getElementById('amount').value = '';
    
    // è‡ªåŠ¨åˆ·æ–°æ•°æ®
    setTimeout(updateData, 2000);
    
  } catch (err) {
    if (err.message.includes('rejected')) {
      alert('æ‚¨å–æ¶ˆäº†äº¤æ˜“');
    } else {
      alert('ç‡ƒçƒ§å¤±è´¥: ' + err.message);
    }
  } finally {
    btn.innerHTML = 'ğŸ”¥ ç«‹å³ç‡ƒçƒ§';
    btn.disabled = false;
  }
}

async function claim() {
  if (!account) {
    alert('è¯·å…ˆè¿æ¥é’±åŒ…');
    return;
  }
  
  const btn = document.getElementById('btnClaim');
  btn.innerHTML = '<span class="loading"></span> é¢†å–ä¸­...';
  btn.disabled = true;
  
  try {
    await contract.methods.claim().send({
      from: account,
      gas: 200000
    });
    
    showSuccess('âœ… åˆ†çº¢é¢†å–æˆåŠŸï¼BNB å·²åˆ°è´¦');
    setTimeout(updateData, 2000);
    
  } catch (err) {
    if (err.message.includes('rejected')) {
      alert('æ‚¨å–æ¶ˆäº†äº¤æ˜“');
    } else {
      alert('é¢†å–å¤±è´¥: ' + (err.message || 'å¯èƒ½æ²¡æœ‰å¯é¢†å–çš„åˆ†çº¢'));
    }
  } finally {
    btn.innerHTML = 'ğŸ’° é¢†å–åˆ†çº¢';
    btn.disabled = false;
  }
}

// è‡ªåŠ¨è¿æ¥
if (localStorage.getItem('walletConnected') === 'true') {
  connect();
}
</script>
</body>
</html>
