<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>è¸é©¬å°ç¥ - ç‡ƒçƒ§åˆ†çº¢</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:#0b0f17;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto}
    .container{max-width:420px;margin:0 auto;padding:25px}
    .card{background:#121a29;border-radius:16px;padding:24px;margin-bottom:16px;border:1px solid #1e293b}
    .title{font-size:22px;font-weight:700;color:#ffdf4f;margin-bottom:6px}
    .subtitle{color:#9ca3af;font-size:14px;margin-bottom:20px}
    
    /* é’±åŒ…è¿æ¥åŒºåŸŸ */
    .wallet-box{background:#1e293b;border-radius:12px;padding:12px 16px;margin-bottom:20px;display:flex;justify-content:space-between;align-items:center}
    .wallet-btn{background:#3b82f6;color:#fff;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600}
    .wallet-btn:hover{background:#2563eb}
    .wallet-address{font-family:monospace;font-size:13px;color:#9ca3af}
    
    .input-box{position:relative;margin-bottom:12px}
    input{width:100%;background:#1e293b;border:none;border-radius:12px;padding:14px 16px;color:#fff;font-size:16px;border:1px solid #374151}
    input:focus{outline:none;border-color:#3b82f6}
    
    button{width:100%;padding:16px;border:none;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;transition:all 0.2s}
    button:disabled{opacity:0.5;cursor:not-allowed}
    .btn-burn{background:#ef4444;color:#fff}
    .btn-burn:hover{background:#dc2626}
    .btn-claim{background:#10b981;color:#fff;margin-top:8px}
    .btn-claim:hover{background:#059669}
    .btn-approve{background:#f59e0b;color:#fff;margin-bottom:8px}
    .btn-approve:hover{background:#d97706}
    
    .panel{display:flex;justify-content:space-between;background:#111827;padding:14px 16px;border-radius:12px;margin-bottom:10px;border:1px solid #1f2937}
    .label{color:#9ca3af;font-size:13px}
    .value{color:#fff;font-weight:600;font-size:15px}
    .value.highlight{color:#ffdf4f}
    
    /* çŠ¶æ€æç¤º */
    .status-box{background:#064e3b;border:1px solid #059669;border-radius:8px;padding:10px 16px;margin-top:12px;font-size:13px;color:#6ee7b7;display:none}
    .status-box.show{display:block}
    .status-box.error{background:#7f1d1d;border-color:#ef4444;color:#fca5a5}
    
    /* åŠ è½½åŠ¨ç”» */
    .loading{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,0.3);border-radius:50%;border-top-color:#fff;animation:spin 0.8s linear infinite;margin-right:8px}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
<div class="container">

  <!-- è¿æ¥é’±åŒ…å¡ç‰‡ -->
  <div class="card">
    <div class="wallet-box">
      <div>
        <div style="font-size:12px;color:#9ca3af;margin-bottom:2px">é’±åŒ…çŠ¶æ€</div>
        <div class="wallet-address" id="walletStatus">æœªè¿æ¥</div>
      </div>
      <button class="wallet-btn" id="connectBtn" onclick="connectWallet()">è¿æ¥é’±åŒ…</button>
    </div>
    
    <div class="title">ğŸ”¥ è¸é©¬å°ç¥ ç‡ƒçƒ§åˆ†çº¢</div>
    <div class="subtitle">Burn To Earn | ç‡ƒçƒ§TAMAè·å–BNBåˆ†çº¢</div>

    <div class="panel">
      <div class="label">æˆ‘çš„TAMAä½™é¢</div>
      <div class="value highlight" id="tokenBalance">0.00 TAMA</div>
    </div>
    
    <div class="panel">
      <div class="label">æˆ‘çš„å¯é¢†å–åˆ†çº¢</div>
      <div class="value" id="pending">0.00 BNB</div>
    </div>
    
    <div class="panel">
      <div class="label">æˆ‘å·²ç‡ƒçƒ§</div>
      <div class="value" id="myburn">0 TAMA</div>
    </div>
    
    <div class="panel">
      <div class="label">å…¨ç½‘æ€»ç‡ƒçƒ§</div>
      <div class="value" id="totalburn">0 TAMA</div>
    </div>

    <div class="status-box" id="statusBox"></div>

    <div class="input-box" style="margin-top:16px">
      <input id="amount" type="number" placeholder="è¾“å…¥ç‡ƒçƒ§æ•°é‡ (TAMA)" min="0" step="0.01"/>
    </div>

    <!-- æˆæƒæŒ‰é’®ï¼ˆåˆå§‹éšè—ï¼Œéœ€è¦æ—¶æ˜¾ç¤ºï¼‰ -->
    <button class="btn-approve" id="approveBtn" onclick="approveToken()" style="display:none">ğŸ”“ æˆæƒåˆçº¦</button>
    
    <button class="btn-burn" id="burnBtn" onclick="burn()" disabled>ğŸ”¥ ç«‹å³ç‡ƒçƒ§</button>
    <button class="btn-claim" id="claimBtn" onclick="claim()" disabled>ğŸ’° é¢†å–åˆ†çº¢</button>
    
    <div style="margin-top:12px;font-size:12px;color:#6b7280;text-align:center">
      åˆçº¦åœ°å€: <span style="font-family:monospace" id="contractAddrDisplay">0x9a88...7777</span>
    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/web3@1.10.3/dist/web3.min.js"></script>
<script>
// ==================== åˆçº¦é…ç½®åŒºåŸŸ ====================
const CONFIG = {
  // åˆçº¦åœ°å€ï¼ˆè¸é©¬å°ç¥åˆçº¦ï¼‰
  contractAddress: "0x9a889E525FAEF4851bf5BEbfb5F294AC9D097777",
  
  // ä»£å¸åˆçº¦åœ°å€ï¼ˆå¦‚æœTAMAä»£å¸å’Œç‡ƒçƒ§åˆçº¦æ˜¯åŒä¸€ä¸ªï¼Œå°±å¡«ä¸€æ ·çš„ï¼‰
  tokenAddress: "0x9a889E525FAEF4851bf5BEbfb5F294AC9D097777",
  
  // ç½‘ç»œé…ç½®ï¼ˆBSCä¸»ç½‘ï¼‰
  chainId: 56,
  chainName: "Binance Smart Chain",
  rpcUrl: "https://bsc-dataseed.binance.org/",
  
  // ä»£å¸ç²¾åº¦ï¼ˆé€šå¸¸æ˜¯18ï¼‰
  decimals: 18
};

// ==================== å®Œæ•´ABIæ¥å£ ====================
// åŒ…å«ERC20æ ‡å‡†æ¥å£ + é¡¹ç›®ç‰¹å®šæ¥å£
const ABI = [
  // === ERC20 æ ‡å‡†æ¥å£ ===
  {
    "constant": true,
   [{"inputs":[{"components":[{"internalType":"address","name":"PCS_V2_FACTORY","type":"address"},{"internalType":"bytes32","name":"PCS_V2_CODE_HASH","type":"bytes32"},{"internalType":"address","name":"PCS_V2_ROUTER","type":"address"},{"internalType":"address","name":"PCS_SMART_ROUTER","type":"address"},{"internalType":"address","name":"WETH","type":"address"},{"internalType":"address","name":"PCS_V3_FACTORY","type":"address"},{"internalType":"bytes32","name":"PCS_V3_CODE_HASH","type":"bytes32"},{"internalType":"address","name":"UNI_V2_FACTORY","type":"address"},{"internalType":"bytes32","name":"UNI_V2_CODE_HASH","type":"bytes32"},{"internalType":"address","name":"UNI_V3_FACTORY","type":"address"},{"internalType":"bytes32","name":"UNI_V3_CODE_HASH","type":"bytes32"},{"internalType":"address","name":"PCS_V4_VAULT","type":"address"},{"internalType":"address","name":"UNI_V4_POOL","type":"address"},{"internalType":"uint256","name":"MIN_LIQ_THRESHOLD","type":"uint256"},{"internalType":"uint256","name":"START_LIQ_THRESHOLD","type":"uint256"},{"internalType":"uint256","name":"ANTI_FARMER_DURATION","type":"uint256"}],"internalType":"struct FlapTaxToken.ConstructorParams","name":"params","type":"tuple"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[],"name":"EIP712DomainChanged","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"quoteToken","type":"address"},{"indexed":false,"internalType":"uint256","name":"taxAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"outputAmount","type":"uint256"}],"name":"FlapTaxLiquidationSuccess","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint8","name":"version","type":"uint8"}],"name":"Initialized","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint8","name":"fromState","type":"uint8"},{"indexed":false,"internalType":"uint8","name":"toState","type":"uint8"}],"name":"PoolStateChanged","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"bytes","name":"reason","type":"bytes"}],"name":"TaxLiquidationError","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"from","type":"address"},{"indexed":false,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"TransferFlapToken","type":"event"},{"inputs":[],"name":"ANTI_FARMER_DURATION","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"DOMAIN_SEPARATOR","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MIN_LIQ_THRESHOLD","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"QUOTE_TOKEN","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"START_LIQ_THRESHOLD","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"TAX_DURATION","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"antiFarmerExpirationTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"subtractedValue","type":"uint256"}],"name":"decreaseAllowance","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"eip712Domain","outputs":[{"internalType":"bytes1","name":"fields","type":"bytes1"},{"internalType":"string","name":"name","type":"string"},{"internalType":"string","name":"version","type":"string"},{"internalType":"uint256","name":"chainId","type":"uint256"},{"internalType":"address","name":"verifyingContract","type":"address"},{"internalType":"bytes32","name":"salt","type":"bytes32"},{"internalType":"uint256[]","name":"extensions","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"finalizeMigration","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"addedValue","type":"uint256"}],"name":"increaseAllowance","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"components":[{"internalType":"string","name":"name","type":"string"},{"internalType":"string","name":"symbol","type":"string"},{"internalType":"string","name":"meta","type":"string"},{"internalType":"uint16","name":"tax","type":"uint16"},{"internalType":"address","name":"taxSplitter","type":"address"},{"internalType":"address","name":"quoteToken","type":"address"},{"internalType":"uint256","name":"liqExpectedOutputAmount","type":"uint256"},{"internalType":"uint256","name":"taxDuration","type":"uint256"}],"internalType":"struct IFlapTaxToken.InitParams","name":"params","type":"tuple"}],"name":"initialize","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"liqExpectedOutputAmount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"liquidationThreshold","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"mainPool","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"maxSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"metaURI","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"nonces","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"},{"internalType":"uint256","name":"deadline","type":"uint256"},{"internalType":"uint8","name":"v","type":"uint8"},{"internalType":"bytes32","name":"r","type":"bytes32"},{"internalType":"bytes32","name":"s","type":"bytes32"}],"name":"permit","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"pools","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"startMigration","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"state","outputs":[{"internalType":"enum FlapTaxToken.PoolState","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"taxExpirationTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"taxRate","outputs":[{"internalType":"uint16","name":"","type":"uint16"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"taxSplitter","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"}]
    "name": "balanceOf",
    "outputs": [{"name": "", "type": "uint256"}],
    "payable": false,
    "stateMutability": "view",
    "type": "function"
  },
  {
    "constant": true,
    "inputs": [{"name": "owner", "type": "address"}, {"name": "spender", "type": "address"}],
    "name": "allowance",
    "outputs": [{"name": "", "type": "uint256"}],
    "payable": false,
    "stateMutability": "view",
    "type": "function"
  },
  {
    "constant": false,
    "inputs": [{"name": "spender", "type": "address"}, {"name": "amount", "type": "uint256"}],
    "name": "approve",
    "outputs": [{"name": "", "type": "bool"}],
    "payable": false,
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "constant": true,
    "inputs": [],
    "name": "totalSupply",
    "outputs": [{"name": "", "type": "uint256"}],
    "payable": false,
    "stateMutability": "view",
    "type": "function"
  },
  {
    "constant": true,
    "inputs": [],
    "name": "decimals",
    "outputs": [{"name": "", "type": "uint8"}],
    "payable": false,
    "stateMutability": "view",
    "type": "function"
  },
  {
    "constant": true,
    "inputs": [],
    "name": "symbol",
    "outputs": [{"name": "", "type": "string"}],
    "payable": false,
    "stateMutability": "view",
    "type": "function"
  },
  {
    "constant": true,
    "inputs": [],
    "name": "name",
    "outputs": [{"name": "", "type": "string"}],
    "payable": false,
    "stateMutability": "view",
    "type": "function"
  },
  
  // === è¸é©¬å°ç¥ç‰¹å®šæ¥å£ ===
  // ç‡ƒçƒ§ä»£å¸
  {
    "inputs": [{"name": "amount", "type": "uint256"}],
    "name": "burn",
    "stateMutability": "nonpayable",
    "type": "function"
  },
  // é¢†å–åˆ†çº¢
  {
    "inputs": [],
    "name": "claim",
    "stateMutability": "nonpayable",
    "type": "function"
  },
  // æŸ¥è¯¢å¯é¢†å–åˆ†çº¢
  {
    "inputs": [{"name": "user", "type": "address"}],
    "name": "claimable",
    "outputs": [{"type": "uint256"}],
    "stateMutability": "view",
    "type": "function"
  },
  // æŸ¥è¯¢ç”¨æˆ·å·²ç‡ƒçƒ§æ•°é‡
  {
    "inputs": [{"name": "user", "type": "address"}],
    "name": "burnAmount",
    "outputs": [{"type": "uint256"}],
    "stateMutability": "view",
    "type": "function"
  },
  // æŸ¥è¯¢å…¨ç½‘æ€»ç‡ƒçƒ§
  {
    "inputs": [],
    "name": "totalBurned",
    "outputs": [{"type": "uint256"}],
    "stateMutability": "view",
    "type": "function"
  },
  
  // === äº‹ä»¶æ—¥å¿— ===
  {
    "anonymous": false,
    "inputs": [
      {"indexed": true, "name": "from", "type": "address"},
      {"indexed": false, "name": "amount", "type": "uint256"}
    ],
    "name": "Burn",
    "type": "event"
  },
  {
    "anonymous": false,
    "inputs": [
      {"indexed": true, "name": "user", "type": "address"},
      {"indexed": false, "name": "amount", "type": "uint256"}
    ],
    "name": "Claim",
    "type": "event"
  }
];

// ==================== å…¨å±€çŠ¶æ€ ====================
let web3 = null;
let contract = null;
let tokenContract = null; // å¦‚æœæ˜¯åŒä¸€ä¸ªåˆçº¦ï¼Œè¿™ä¸ªå’Œcontractä¸€æ ·
let userAddress = null;
let isConnected = false;

// ==================== æ ¸å¿ƒåŠŸèƒ½ ====================

// æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
function showStatus(msg, isError = false) {
  const box = document.getElementById('statusBox');
  box.textContent = msg;
  box.className = 'status-box show' + (isError ? ' error' : '');
  setTimeout(() => {
    box.classList.remove('show');
  }, 5000);
}

// è¿æ¥é’±åŒ…
async function connectWallet() {
  const btn = document.getElementById('connectBtn');
  
  try {
    if (!window.ethereum) {
      alert('è¯·å®‰è£…MetaMaské’±åŒ…ï¼');
      return;
    }
    
    btn.innerHTML = '<span class="loading"></span>è¿æ¥ä¸­...';
    
    // è¯·æ±‚è¿æ¥
    await ethereum.request({ method: 'eth_requestAccounts' });
    
    // åˆå§‹åŒ–web3
    web3 = new Web3(ethereum);
    
    // æ£€æŸ¥ç½‘ç»œ
    const chainId = await web3.eth.getChainId();
    if (chainId !== CONFIG.chainId) {
      try {
        await ethereum.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId: '0x' + CONFIG.chainId.toString(16) }],
        });
      } catch (switchError) {
        // å¦‚æœç½‘ç»œä¸å­˜åœ¨ï¼Œæ·»åŠ ç½‘ç»œ
        if (switchError.code === 4902) {
          await ethereum.request({
            method: 'wallet_addEthereumChain',
            params: [{
              chainId: '0x' + CONFIG.chainId.toString(16),
              chainName: CONFIG.chainName,
              nativeCurrency: { name: 'BNB', symbol: 'BNB', decimals: 18 },
              rpcUrls: [CONFIG.rpcUrl],
              blockExplorerUrls: ['https://bscscan.com/']
            }],
          });
        } else {
          throw switchError;
        }
      }
      // é‡æ–°åˆå§‹åŒ–web3
      web3 = new Web3(ethereum);
    }
    
    // è·å–è´¦æˆ·
    const accounts = await web3.eth.getAccounts();
    userAddress = accounts[0];
    isConnected = true;
    
    // åˆå§‹åŒ–åˆçº¦
    contract = new web3.eth.Contract(ABI, CONFIG.contractAddress);
    tokenContract = contract; // å¦‚æœæ˜¯åŒä¸€ä¸ªåˆçº¦
    
    // æ›´æ–°UI
    document.getElementById('walletStatus').textContent = 
      userAddress.slice(0,6) + '...' + userAddress.slice(-4);
    btn.textContent = 'å·²è¿æ¥';
    btn.disabled = true;
    
    document.getElementById('burnBtn').disabled = false;
    document.getElementById('claimBtn').disabled = false;
    
    // åŠ è½½æ•°æ®
    await loadUserData();
    
    // ç›‘å¬è´¦æˆ·å˜åŒ–
    ethereum.on('accountsChanged', (accounts) => {
      if (accounts.length === 0) {
        window.location.reload();
      } else {
        userAddress = accounts[0];
        document.getElementById('walletStatus').textContent = 
          userAddress.slice(0,6) + '...' + userAddress.slice(-4);
        loadUserData();
      }
    });
    
    showStatus('é’±åŒ…è¿æ¥æˆåŠŸï¼');
    
  } catch (error) {
    console.error(error);
    btn.textContent = 'è¿æ¥å¤±è´¥';
    showStatus('è¿æ¥å¤±è´¥: ' + error.message, true);
    setTimeout(() => {
      btn.textContent = 'è¿æ¥é’±åŒ…';
    }, 2000);
  }
}

// åŠ è½½ç”¨æˆ·æ•°æ®ï¼ˆä½™é¢ã€åˆ†çº¢ç­‰ï¼‰
async function loadUserData() {
  if (!contract || !userAddress) return;
  
  try {
    // 1. æŸ¥è¯¢TAMAä»£å¸ä½™é¢
    const balance = await contract.methods.balanceOf(userAddress).call();
    const balanceFormatted = web3.utils.fromWei(balance, 'ether');
    document.getElementById('tokenBalance').textContent = 
      parseFloat(balanceFormatted).toFixed(2) + ' TAMA';
    
    // 2. æŸ¥è¯¢å¯é¢†å–åˆ†çº¢ï¼ˆBNBï¼‰
    const claimable = await contract.methods.claimable(userAddress).call();
    const claimableFormatted = web3.utils.fromWei(claimable, 'ether');
    document.getElementById('pending').textContent = 
      parseFloat(claimableFormatted).toFixed(4) + ' BNB';
    
    // 3. æŸ¥è¯¢æˆ‘å·²ç‡ƒçƒ§æ•°é‡
    const myBurn = await contract.methods.burnAmount(userAddress).call();
    const myBurnFormatted = web3.utils.fromWei(myBurn, 'ether');
    document.getElementById('myburn').textContent = 
      parseFloat(myBurnFormatted).toFixed(2) + ' TAMA';
    
    // 4. æŸ¥è¯¢å…¨ç½‘æ€»ç‡ƒçƒ§
    const totalBurn = await contract.methods.totalBurned().call();
    const totalBurnFormatted = web3.utils.fromWei(totalBurn, 'ether');
    document.getElementById('totalburn').textContent = 
      parseFloat(totalBurnFormatted).toLocaleString() + ' TAMA';
    
    // 5. æ£€æŸ¥æˆæƒçŠ¶æ€ï¼ˆæ˜¯å¦éœ€è¦å…ˆæˆæƒï¼‰
    await checkAllowance();
    
  } catch (error) {
    console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
    showStatus('åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•', true);
  }
}

// æ£€æŸ¥æˆæƒé¢åº¦
async function checkAllowance() {
  try {
    const allowance = await contract.methods.allowance(userAddress, CONFIG.contractAddress).call();
    const allowanceFormatted = parseFloat(web3.utils.fromWei(allowance, 'ether'));
    
    // å¦‚æœæˆæƒé¢åº¦å¾ˆå°ï¼Œæ˜¾ç¤ºæˆæƒæŒ‰é’®
    if (allowanceFormatted < 1000000) { // å°äº100ä¸‡è§†ä¸ºæœªæˆæƒ
      document.getElementById('approveBtn').style.display = 'block';
      document.getElementById('burnBtn').disabled = true;
      document.getElementById('burnBtn').textContent = 'è¯·å…ˆæˆæƒ';
    } else {
      document.getElementById('approveBtn').style.display = 'none';
      document.getElementById('burnBtn').disabled = false;
      document.getElementById('burnBtn').textContent = 'ğŸ”¥ ç«‹å³ç‡ƒçƒ§';
    }
  } catch (e) {
    console.log('æ£€æŸ¥æˆæƒå¤±è´¥:', e);
  }
}

// æˆæƒä»£å¸ç»™åˆçº¦
async function approveToken() {
  if (!isConnected) {
    alert('è¯·å…ˆè¿æ¥é’±åŒ…');
    return;
  }
  
  const btn = document.getElementById('approveBtn');
  const originalText = btn.textContent;
  
  try {
    btn.innerHTML = '<span class="loading"></span>æˆæƒä¸­...';
    btn.disabled = true;
    
    // æˆæƒæœ€å¤§å€¼
    const maxAmount = web3.utils.toWei('999999999999', 'ether');
    
    const tx = await contract.methods.approve(CONFIG.contractAddress, maxAmount)
      .send({ from: userAddress });
    
    showStatus('æˆæƒæˆåŠŸï¼ç°åœ¨å¯ä»¥ç‡ƒçƒ§äº†');
    await checkAllowance(); // åˆ·æ–°æŒ‰é’®çŠ¶æ€
    
  } catch (error) {
    console.error(error);
    showStatus('æˆæƒå¤±è´¥: ' + error.message, true);
    btn.textContent = originalText;
    btn.disabled = false;
  }
}

// ç‡ƒçƒ§ä»£å¸
async function burn() {
  const amt = document.getElementById("amount").value;
  if (!amt || parseFloat(amt) <= 0) {
    showStatus("è¯·è¾“å…¥ç‡ƒçƒ§æ•°é‡", true);
    return;
  }
  
  const btn = document.getElementById("burnBtn");
  
  try {
    btn.innerHTML = '<span class="loading"></span>æäº¤ä¸­...';
    btn.disabled = true;
    
    const val = web3.utils.toWei(amt, "ether");
    
    const tx = await contract.methods.burn(val).send({ from: userAddress });
    
    showStatus("âœ… ç‡ƒçƒ§æˆåŠŸï¼è·å¾—åˆ†çº¢æƒ");
    document.getElementById("amount").value = "";
    
    // åˆ·æ–°æ•°æ®
    await loadUserData();
    
  } catch (error) {
    console.error(error);
    showStatus("ç‡ƒçƒ§å¤±è´¥: " + error.message, true);
  } finally {
    btn.textContent = "ğŸ”¥ ç«‹å³ç‡ƒçƒ§";
    btn.disabled = false;
  }
}

// é¢†å–åˆ†çº¢
async function claim() {
  const btn = document.getElementById("claimBtn");
  
  try {
    btn.innerHTML = '<span class="loading"></span>é¢†å–ä¸­...';
    btn.disabled = true;
    
    const tx = await contract.methods.claim().send({ from: userAddress });
    
    showStatus("âœ… åˆ†çº¢é¢†å–æˆåŠŸï¼");
    
    // åˆ·æ–°æ•°æ®
    await loadUserData();
    
  } catch (error) {
    console.error(error);
    showStatus("é¢†å–å¤±è´¥: " + error.message, true);
  } finally {
    btn.textContent = "ğŸ’° é¢†å–åˆ†çº¢";
    btn.disabled = false;
  }
}

// è‡ªåŠ¨åˆ·æ–°æ•°æ®ï¼ˆæ¯30ç§’ï¼‰
setInterval(() => {
  if (isConnected) {
    loadUserData();
  }
}, 30000);

// é¡µé¢åŠ è½½å®Œæˆåæ˜¾ç¤ºåˆçº¦åœ°å€
document.getElementById('contractAddrDisplay').textContent = 
  CONFIG.contractAddress.slice(0,6) + '...' + CONFIG.contractAddress.slice(-4);
</script>
</body>
</html>
