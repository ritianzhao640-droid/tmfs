<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>è¸é©¬å°ç¥ - ç‡ƒçƒ§åˆ†çº¢</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:#0b0f17;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto}
    .container{max-width:420px;margin:0 auto;padding:25px}
    
    .wallet-bar{background:linear-gradient(135deg,#1e293b 0%,#0f172a 100%);border:1px solid #334155;border-radius:12px;padding:12px 16px;margin-bottom:20px}
    .wallet-status{display:flex;align-items:center;gap:8px;font-size:14px}
    .status-dot{width:8px;height:8px;border-radius:50%;background:#ef4444;transition:all 0.3s}
    .status-dot.connected{background:#10b981;box-shadow:0 0 8px #10b981}
    .wallet-btn{background:#3b82f6;color:#fff;border:none;padding:8px 16px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer}
    
    .card{background:#121a29;border-radius:16px;padding:24px;margin-bottom:16px}
    .title{font-size:22px;font-weight:700;color:#ffdf4f;margin-bottom:6px}
    .subtitle{color:#9ca3af;font-size:14px;margin-bottom:20px}
    input{width:100%;background:#1e293b;border:none;border-radius:12px;padding:14px 16px;color:#fff;font-size:16px;margin-bottom:8px}
    button{width:100%;padding:16px;border:none;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;margin-bottom:8px}
    .btn-approve{background:#f59e0b;color:#fff}
    .btn-burn{background:#ef4444;color:#fff}
    .btn-burn:disabled{background:#7f1d1d;cursor:not-allowed}
    .btn-alt{background:#8b5cf6;color:#fff}
    .btn-claim{background:#10b981;color:#fff;margin-top:8px}
    
    .panel{display:flex;justify-content:space-between;background:#111827;padding:14px 16px;border-radius:12px;margin-bottom:10px}
    .label{color:#9ca3af;font-size:13px}
    .value{color:#fff;font-weight:600}
    
    .debug-box{background:#1e1b4b;border:1px solid #4338ca;padding:12px;border-radius:8px;margin:12px 0;font-size:12px;font-family:monospace;max-height:150px;overflow-y:auto}
    .error{color:#fca5a5}
    .success{color:#6ee7b7}
    .warning{color:#fcd34d}
    
    .tip{font-size:12px;color:#94a3b8;margin-top:8px;padding:10px;background:#0f172a;border-radius:8px;border-left:3px solid #3b82f6}
  </style>
</head>
<body>
<div class="container">

  <div class="wallet-bar">
    <div class="wallet-status">
      <div class="status-dot" id="statusDot"></div>
      <span id="statusText">æœªè¿æ¥</span>
    </div>
    <button class="wallet-btn" onclick="toggleConnect()">è¿æ¥</button>
  </div>

  <div class="card">
    <div class="title">ğŸ”¥ è¸é©¬å°ç¥ ç‡ƒçƒ§åˆ†çº¢</div>
    <div class="subtitle">Burn To Earn | ç‡ƒçƒ§è·å–åˆ†çº¢æƒ</div>

    <div class="panel">
      <div class="label">æˆ‘çš„å¯é¢†å–åˆ†çº¢</div>
      <div class="value" id="pending">--</div>
    </div>
    <div class="panel">
      <div class="label">æˆ‘å·²ç‡ƒçƒ§</div>
      <div class="value" id="myburn">--</div>
    </div>
    <div class="panel">
      <div class="label">ä»£å¸ä½™é¢</div>
      <div class="value" id="balance">--</div>
    </div>

    <div style="margin:20px 0;">
      <input id="amount" type="number" placeholder="è¾“å…¥ç‡ƒçƒ§æ•°é‡ï¼ˆå»ºè®®å…ˆå°é¢æµ‹è¯•ï¼‰" min="0" step="0.01"/>
    </div>

    <button class="btn-approve" id="btnApprove" onclick="approve()">1ï¸âƒ£ æˆæƒä»£å¸</button>
    <button class="btn-burn" id="btnBurn" onclick="burn()" disabled>2ï¸âƒ£ ç«‹å³ç‡ƒçƒ§</button>
    <button class="btn-alt" id="btnAlt" onclick="burnAlternative()" style="display:none">ğŸ”„ å¤‡é€‰ç‡ƒçƒ§æ–¹å¼</button>
    <button class="btn-claim" onclick="claim()">ğŸ’° é¢†å–åˆ†çº¢</button>
    
    <div class="tip">
      ğŸ’¡ <strong>å¸¸è§é—®é¢˜ï¼š</strong><br>
      1. å¦‚æœç‡ƒçƒ§å¤±è´¥ï¼Œå°è¯•å¢åŠ æ•°é‡ï¼ˆéƒ¨åˆ†åˆçº¦è¦æ±‚æœ€å°‘ 1000 å¸ï¼‰<br>
      2. ç¡®ä¿é’±åŒ…é‡Œæœ‰ BNB æ”¯ä»˜ Gas<br>
      3. é¦–æ¬¡ä½¿ç”¨å¿…é¡»å…ˆæˆæƒ
    </div>
  </div>

  <div class="debug-box" id="debugBox">
    <div class="warning">ç­‰å¾…è¿æ¥...</div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/web3@1.10.3/dist/web3.min.js"></script>
<script>
const CONTRACT = "0x9a889E525FAEF4851bf5BEbfb5F294AC9D097777";
const MAX_UINT = "115792089237316195423570985008687907853269984665640564039457584007913129639935";

const ABI = [
  {"constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"constant":true,"inputs":[{"name":"_owner","type":"address"},{"name":"_spender","type":"address"}],"name":"allowance","outputs":[{"name":"remaining","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"name":"_spender","type":"address"},{"name":"_value","type":"uint256"}],"name":"approve","stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"name":"amount","type":"uint256"}],"name":"burn","stateMutability":"nonpayable","type":"function"},
  {"inputs":[],"name":"claim","stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"name":"user","type":"address"}],"name":"claimable","outputs":[{"name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"name":"user","type":"address"}],"name":"burnAmount","outputs":[{"name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"totalBurned","outputs":[{"name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  // å¤‡é€‰ï¼šæœ‰äº›åˆçº¦ç”¨ transfer åˆ° 0x0 åœ°å€æ¥ burn
  {"inputs":[{"name":"_to","type":"address"},{"name":"_value","type":"uint256"}],"name":"transfer","stateMutability":"nonpayable","type":"function"}
];

let web3, account, contract;

function log(msg, type='info') {
  const box = document.getElementById('debugBox');
  const div = document.createElement('div');
  div.className = type;
  div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

async function toggleConnect() {
  if (account) {
    location.reload();
  } else {
    connect();
  }
}

async function connect() {
  try {
    if (!window.ethereum) {
      alert('è¯·ä½¿ç”¨ TokenPocket æˆ– MetaMask æµè§ˆå™¨');
      return;
    }
    
    web3 = new Web3(window.ethereum);
    const accounts = await window.ethereum.request({method: 'eth_requestAccounts'});
    account = accounts[0];
    
    contract = new web3.eth.Contract(ABI, CONTRACT);
    
    document.getElementById('statusDot').classList.add('connected');
    document.getElementById('statusText').textContent = account.slice(0,6) + '...' + account.slice(-4);
    
    log('é’±åŒ…è¿æ¥æˆåŠŸ: ' + account, 'success');
    
    await updateData();
    await checkAuth();
    
    // ç›‘å¬
    window.ethereum.on('accountsChanged', (accs) => {
      if (accs.length === 0) location.reload();
      else { account = accs[0]; updateData(); checkAuth(); }
    });
    
  } catch (err) {
    log('è¿æ¥å¤±è´¥: ' + err.message, 'error');
  }
}

async function updateData() {
  try {
    const bal = await contract.methods.balanceOf(account).call();
    const balEth = web3.utils.fromWei(bal, 'ether');
    document.getElementById('balance').textContent = parseFloat(balEth).toFixed(2) + ' è¸é©¬å°ç¥';
    document.getElementById('maxAmount')?.remove();
    
    const claim = await contract.methods.claimable(account).call();
    document.getElementById('pending').textContent = parseFloat(web3.utils.fromWei(claim,'ether')).toFixed(4) + ' BNB';
    
    const burned = await contract.methods.burnAmount(account).call();
    document.getElementById('myburn').textContent = web3.utils.fromWei(burned,'ether') + ' è¸é©¬å°ç¥';
    
  } catch (err) {
    log('æ•°æ®åŠ è½½å¤±è´¥: ' + err.message, 'error');
  }
}

async function checkAuth() {
  try {
    const allowance = await contract.methods.allowance(account, CONTRACT).call();
    const allowed = web3.utils.fromWei(allowance, 'ether');
    log(`å·²æˆæƒé¢åº¦: ${allowed}`, 'info');
    
    if (parseFloat(allowed) > 1000000) {
      document.getElementById('btnBurn').disabled = false;
      document.getElementById('btnApprove').style.opacity = '0.5';
      log('å·²æˆæƒï¼Œå¯ä»¥ç‡ƒçƒ§', 'success');
    } else {
      document.getElementById('btnBurn').disabled = true;
      log('æœªæˆæƒï¼Œè¯·å…ˆç‚¹å‡»æˆæƒæŒ‰é’®', 'warning');
    }
  } catch (err) {
    log('æ£€æŸ¥æˆæƒå¤±è´¥: ' + err.message, 'error');
  }
}

async function approve() {
  const btn = document.getElementById('btnApprove');
  btn.textContent = 'æˆæƒä¸­...';
  btn.disabled = true;
  
  try {
    log('æ­£åœ¨æˆæƒåˆçº¦ä½¿ç”¨ä»£å¸...', 'info');
    
    await contract.methods.approve(CONTRACT, MAX_UINT).send({from: account})
      .on('transactionHash', hash => {
        log('æˆæƒäº¤æ˜“å·²æäº¤: ' + hash.slice(0,10) + '...', 'success');
      });
    
    log('âœ… æˆæƒæˆåŠŸï¼', 'success');
    await checkAuth();
    
  } catch (err) {
    log('âŒ æˆæƒå¤±è´¥: ' + err.message, 'error');
    btn.textContent = '1ï¸âƒ£ æˆæƒä»£å¸';
    btn.disabled = false;
  }
}

async function burn() {
  const amount = document.getElementById('amount').value;
  if (!amount || amount <= 0) {
    log('è¯·è¾“å…¥ç‡ƒçƒ§æ•°é‡', 'error');
    return;
  }
  
  const btn = document.getElementById('btnBurn');
  btn.textContent = 'ç‡ƒçƒ§ä¸­...';
  btn.disabled = true;
  
  try {
    // æ£€æŸ¥æˆæƒ
    const allowance = await contract.methods.allowance(account, CONTRACT).call();
    const need = web3.utils.toWei(amount, 'ether');
    
    if (parseFloat(allowance) < parseFloat(need)) {
      log('æˆæƒé¢åº¦ä¸è¶³ï¼Œè¯·å…ˆæˆæƒ', 'error');
      btn.textContent = '2ï¸âƒ£ ç«‹å³ç‡ƒçƒ§';
      btn.disabled = true;
      return;
    }
    
    log(`å‡†å¤‡ç‡ƒçƒ§ ${amount} ä¸ªä»£å¸...`, 'info');
    
    // å°è¯•ç‡ƒçƒ§ï¼Œå¢åŠ  Gas Limit é˜²æ­¢ Gas ä¸è¶³
    await contract.methods.burn(need).send({
      from: account,
      gas: 300000  // å¢åŠ  Gas é™åˆ¶
    }).on('transactionHash', hash => {
      log('ç‡ƒçƒ§äº¤æ˜“å·²æäº¤: ' + hash.slice(0,10), 'success');
    });
    
    log('âœ… ç‡ƒçƒ§æˆåŠŸï¼', 'success');
    document.getElementById('amount').value = '';
    await updateData();
    
  } catch (err) {
    log('âŒ ç‡ƒçƒ§å¤±è´¥: ' + err.message, 'error');
    
    // æ˜¾ç¤ºå…·ä½“é”™è¯¯
    if (err.message.includes('insufficient funds')) {
      log('é”™è¯¯ï¼šBNB ä½™é¢ä¸è¶³æ”¯ä»˜ Gas', 'error');
    } else if (err.message.includes('transfer amount exceeds balance')) {
      log('é”™è¯¯ï¼šä»£å¸ä½™é¢ä¸è¶³', 'error');
    } else if (err.message.includes('burn amount exceeds balance')) {
      log('é”™è¯¯ï¼šç‡ƒçƒ§æ•°é‡è¶…è¿‡ä½™é¢', 'error');
    } else if (err.message.includes('min burn')) {
      log('é”™è¯¯ï¼šç‡ƒçƒ§æ•°é‡å¤ªå°ï¼ˆå¯èƒ½è¦æ±‚æœ€å°‘ 1000 å¸ï¼‰', 'error');
    } else if (err.message.includes('pool')) {
      log('é”™è¯¯ï¼šåˆ†çº¢æ± å¯èƒ½ä¸ºç©ºï¼Œæ— æ³•ç‡ƒçƒ§', 'error');
      document.getElementById('btnAlt').style.display = 'block';
    } else {
      log('è¯¦ç»†é”™è¯¯: ' + JSON.stringify(err).slice(0,200), 'error');
      document.getElementById('btnAlt').style.display = 'block';
    }
    
  } finally {
    btn.textContent = '2ï¸âƒ£ ç«‹å³ç‡ƒçƒ§';
    btn.disabled = false;
  }
}

// å¤‡é€‰æ–¹æ¡ˆï¼šæœ‰äº›åˆçº¦éœ€è¦é€šè¿‡ transfer åˆ°ç‰¹å®šåœ°å€æ¥ burn
async function burnAlternative() {
  const amount = document.getElementById('amount').value;
  if (!amount) return;
  
  log('å°è¯•å¤‡é€‰æ–¹æ¡ˆï¼šç›´æ¥è½¬å¸åˆ°åˆçº¦åœ°å€...', 'warning');
  
  try {
    const need = web3.utils.toWei(amount, 'ether');
    
    // æœ‰äº›åˆçº¦é€šè¿‡æ¥æ”¶ä»£å¸è‡ªåŠ¨ burn
    await contract.methods.transfer(CONTRACT, need).send({
      from: account,
      gas: 200000
    });
    
    log('âœ… å¤‡é€‰æ–¹æ¡ˆæˆåŠŸï¼ä»£å¸å·²è½¬å…¥åˆçº¦', 'success');
    await updateData();
    
  } catch (err) {
    log('å¤‡é€‰æ–¹æ¡ˆä¹Ÿå¤±è´¥äº†: ' + err.message, 'error');
  }
}

async function claim() {
  try {
    log('å‡†å¤‡é¢†å–åˆ†çº¢...', 'info');
    await contract.methods.claim().send({from: account, gas: 200000});
    log('âœ… é¢†å–æˆåŠŸï¼', 'success');
    await updateData();
  } catch (err) {
    log('é¢†å–å¤±è´¥: ' + err.message, 'error');
  }
}

// è‡ªåŠ¨è¿æ¥
if (localStorage.getItem('walletConnected')) connect();
setInterval(() => { if(account) updateData() }, 15000);
</script>
</body>
</html>
